<extend name="./base" />
<!-- 支付通知 -->
<block name="main">

    <div class="container">
        <div class="col-md-2">
        	<include file="Public:authNav" />
        </div>
        <div class="col-md-10">
        	<div class="rtop">
        		<ul class="list-inline">
 				 <li class="blue"><a href="javascript:void;">批次号列表</a></li>

				<li>
				<if condition="$rest_num lt 500">
				
					<font style="color:red;font-weight:bold;font-size:16px;"><img src="__PUBLIC__/images/warning.png" alt="" height="30" width="30">中通号仅余下 <span style="font-size:20px;" id="rest_num">{:($rest_num === false) ? "查询失败" : $rest_num}</span> 张，请及时补充</font>

				<else />

					<font style="font-weight:bold;font-size:16px;"><img src="__PUBLIC__/images/lighting.png" alt="" height="30" width="30">中通号剩余数量：<span id="rest_num">{:($rest_num === false) ? "查询失败" : $rest_num}</span> 张</font>

				</if>
				</li>
				&nbsp;<a href="javascript:void;" onclick="reload();"><img src="__PUBLIC__/images/reload.png" alt="" height="35" width="35" title="刷新"></a>

 				 <li style="float:right;font-size: 17px;">您当前所在位置：美快优选3&nbsp;/&nbsp;<a href="javascript:void(0);" class="color">节点推送</a></li>
				</ul>
				<table border="0" cellpadding="0" cellspacing="0" class="table" style="margin-bottom:0px">
						<tr>
							<td>
							<form action="{:U(CONTROLLER_NAME.'/'.ACTION_NAME)}" method="get" class="form-inline">
							<!-- 中文搜索时必须的 -->
							<input type="hidden" name="m" value="{$Think.MODULE_NAME}" />
							<input type="hidden" name="c" value="{$Think.CONTROLLER_NAME}" />
							<input type="hidden" name="a" value="{$Think.ACTION_NAME}" />
							<!-- End -->	

							<!-- 搜索栏 -->
							<script type="text/javascript" src="__PUBLIC__/js/datetime/DateTimePicker.js"></script>
							<link href="__PUBLIC__/js/datetime/DateTimePicker.css" rel="stylesheet">
							<script type="text/javascript">
								$(document).ready(function()
										{
											$("#dtBox").DateTimePicker({

												minuteInterval: 5

											});
										});
							</script>
							<div id="dtBox"></div><label>
											搜索:&nbsp;
											<input type="search" name="keyword" value="{$keyword}" class="form-control" style="width:160" />
											</label>
											<label>
											
											<select name="searchtype" class="form-control" >
												<option value="" selected>查询类别</option>
												<option value="no" <eq name="searchtype" value="no">selected</eq>>中转批号</option>
											</select>
											</label>
											<label>&nbsp;隶属线路
												<select name="tid" class="form-control">
												<option value="">全部</option>
												<volist name="center_list" id="vt">
													<option value="{$vt[id]}" <if condition="I('tid') eq $vt['id']">selected</if>>{$vt['name']}</option>
												</volist>
											</select>
											</label>
											<label>&nbsp;

											中转批号创建时间：
											<input type="text" class="form-control one" data-field="datetime" size="25" id="createStarttime" value="<eq name="starttime" value=""><else />{$starttime|date='Y-m-d H:i:s',###}</eq>" style="width:166" > -- <input type="text" class="form-control two" data-field="datetime" size="25" id="createEndtime" value="<eq name="endtime" value=""><else />{$endtime|date='Y-m-d H:i:s',###}</eq>" style="width:166" >
											</label>
											<input type="hidden" id="starttime" name="starttime">
											<input type="hidden" id="endtime" name="endtime">
											<label>

													<button type="submit" class="btn btn-primary " style="background-color:#3071a9;" onclick="ccc()">查询</button>
											</label>
										
							<script type="text/javascript">
							function ccc(){
								var startTime=document.getElementById("createStarttime").value;
								if(startTime != ''){
									var startback = transdate(startTime);
									document.getElementById("starttime").value=startback;
								}

								var endTime=document.getElementById("createEndtime").value;
								if(endTime != ''){
									var endback = transdate(endTime);
									document.getElementById("endtime").value=endback;
								}

							}
							function transdate(startTime){
								var date=new Date();
								date.setFullYear(startTime.substring(0,4));
								date.setMonth(startTime.substring(5,7)-1);
								date.setDate(startTime.substring(8,10));
								date.setHours(startTime.substring(11,13));
								date.setMinutes(startTime.substring(14,16));
								date.setSeconds(startTime.substring(17,19));
								return Date.parse(date)/1000;
							}
							function transdate(endTime){
								var date=new Date();
								date.setFullYear(endTime.substring(0,4));
								date.setMonth(endTime.substring(5,7)-1);
								date.setDate(endTime.substring(8,10));
								date.setHours(endTime.substring(11,13));
								date.setMinutes(endTime.substring(14,16));
								date.setSeconds(endTime.substring(17,19));
								return Date.parse(date)/1000;
							}

							</script>
							<!-- 搜索栏end -->

						</form>
						</td>
					</tr>
			</table>
				<ta<!-- 公共部分 数据展示 St2Ems,SfLogistics,Logistics-->
<style>
	dt{padding-top: 5px;text-align: center;}
	.container h3{font-size:26px;}
	.btn{width:58px;height:30px;background-color: #eee;}
	.searchbox{width:88%;margin:0 auto;}
</style>

<form action="">
<div class="container" style="">
	<volist name="list" id="vo">
		<div style="width:315px;height:315px;border:1px dotted black;float:left;margin-left:30px;margin-bottom:30px;">
			<div style="padding-top:2px;" id="addAirno_{$vo['id']}">
				<if condition="$vo['sort'] eq count($ZT_Node_Point_CN)">
					<span style="border:solid 1px #000;padding:2px 2px;">最后阶段：<font color="green">完</font></span>
				<elseif condition="$vo['sort'] eq '0'" />
					<span style="border:solid 1px #000;padding:2px 2px;">现阶段：<font color="red">未开始</font></span>
				<else />
					<span style="border:solid 1px #000;padding:2px 2px;">现阶段：{$ZT_Node_Point_CN[$vo['sort']-1]}</span>
				</if>
				<h3 style="text-align: center;" title="中转批号"><strong>{$vo['no']}</strong></h3>
				<dt title="中转批号创建时间">{$vo['date']}</dt>
				<dt title="线路名称">{$vo['name']}</dt>
				<dt title="保存航空号时间">{$vo['airdatetime']}</dt>
				<dt style="padding-left:180px;">
					总数：<span class="all{$vo.id}"><a target="_blank" href="{:U('PostManagement/showList',array('mstr'=>$vo['no'],'stype'=>'normal','id'=>$vo['id']))}">{$vo['all']}</a></span><br />
					菜鸟总数：
					<span>
						{$vo['lp']}
						<if condition="$vo['all'] neq $vo['lp']">
							<a target="_blank" href="{:U('StTransferLp/index',array('noid'=>$vo['id']))}">补录</a>
						</if>
					</span>
				</dt>

				<dt>
				<div id="s_record_{$vo['id']}" style="display:none;">

				</div>
						<!-- <a href="{:U('LogisticsNode/toPush',array('noid'=>$vo['id']))}"><button type="button" class="btn btn-default{$vo['id']}">调试</button></a> -->
					<!-- <label><input type="checkbox" name="kd_{$vo['id']}">&nbsp;强制推送到物流服务商</label><br/><br/> -->
					<span><button type="button" class="btn btn-default{$vo['id']}" onclick="toPush('{$vo.id}','{$vo.tcid}');" style="width: 135px;">
						<if condition="$vo['sort'] eq count($ZT_Node_Point_CN)">
							推送完毕
						<elseif  condition="$vo['not'] gt 0 && $vo['sort'] gt 0" />
							现阶段续推
						<else />
							{$ZT_Node_Point_CN[$vo['sort']]}
						</if>
					</button></span><br />
<!-- 					<if condition="$vo['sort'] gt 0 && $vo['done'] gt 0">
						<div style="margin-top:5px;"><button type="button" class="btn btn-default{$vo['id']}" onclick="toPost('{$vo.id}','{$vo.tcid}');" style="width: 135px;">发送到物流服务商</button></div>
					</if> -->
					<!-- <a href="{:U('MKBc3/toPost',array('id'=>$vo['id'],'tcid'=>$vo['tcid']))}"><button type="button" class="btn btn-default{$vo['id']}">物流服务商</button></a> -->
					&nbsp;
					<if condition="$vo['sort'] gt 0">
					<if condition="$vo['done'] gt '0' || $vo['not'] gt '0'">
					<br>
						现阶段反馈：
<!-- 						<a target="_blank" href="{:U('PostManagement/orderList',array('nid'=>$vo['id'],'kind'=>'not'))}">未发送：{$vo['not']}</a>，&nbsp;
						<a target="_blank" href="{:U('PostManagement/orderList',array('nid'=>$vo['id'],'kind'=>'done'))}">已发送：{$vo['done']}</a>&nbsp;<br> -->
						<a href="javascript:void">未发送：{$vo['not']}</a>，&nbsp;
						<a href="javascript:void">已发送：{$vo['done']}</a>&nbsp;<br>
					</if>
					</if>
				</dt>
			</div>
		</div>	
	</volist>
</div>
<script>
	function toPush(id,tcid){
		var kd = $("input[name='kd_"+id+"'"+"]:checked").val();
		// alert(kd);exit;
		$.ajax({
			url:'{:U('LogisticsNode/toPush')}',
			timeout:0,
			type:'post',
			dataType:'json',
			data:{
				'noid':id,
				// 'tcid':tcid,
				// 'kd':kd,
			},
			beforeSend:function(){
				$(".btn.btn-default"+id).html('<img style="width:18px;height:18px;" src="__PUBLIC__/images/msg_loading_d.gif"/>');
			},
			success:function (result){
				// $(".btn.btn-default"+id).attr('disabled','disabled');

				if(result.status == '500'){
					layer.open({
					  	type: 2,
				        title: ['补填航空号','font-size:17px;'],
				        area: ['600px', '310px'],
				        offset:'30%',
				        content: [result.url, 'no'], //iframe的url； 'no'：禁止iframe出现滚动条
				        btn: ['确定', '取消'], //
						yes: function(){
						var fname = $('#addAirno_'+id).attr('fname');//文件夹名称
							$.ajax({
							      url:'{:U('LogisticsNode/add_method')}',
							      type:'post',
							      dataType:'json',
							      cache:false,
							      data:{
							        'noid':id,
							        'fname':fname,
							      },
							      success:function(result){
							        if(result.state == 'yes'){
							          layer.msg(result.msg, {icon: 1,time: 2000},function(){window.location=window.location});
							          layer.closeAll('iframe'); //关闭所有的iframe层
							        }else{
							          layer.msg(result.msg, {icon: 2,time: 2000});
							        }
							      },
							      beforeSend:function(){
							        layer.msg('正在执行操作...', {icon: 16,shade:0.3});
							      },
							      //提交请求之后无论返回什么结果，统一执行此操作
							      complete: function () {
							      	$('#addAirno_'+id).removeAttr('fname');  //移除元素
							        layer.closeAll('loading');  //关闭所有关于载入中的提示
							      },
							  });
							},
						end:function(){window.location=window.location},
						});
				}else{
					alert(result.msg);
					// layer.msg(result.msg, {icon: 6,time: 0},function(){window.location=window.location});
					window.location=window.location;       //刷新页面
				}
			},
		    // complete:function(){
		    //   window.location=window.location;       //刷新页面
		    // }
		})
	}

	//暂时保留，但不使用
	function toPost(id,tcid){
		var kd = $("input[name='kd_"+id+"'"+"]:checked").val();
		// alert(kd);exit;
		$.ajax({
			url:'{:U('MKBc3/toPost')}',
			type:'post',
			dataType:'json',
			data:{
				'id':id,
				'tcid':tcid,
				'kd':kd,
			},
			beforeSend:function(){
				$(".btn.btn-default"+id).html('<img style="width:18px;height:18px;" src="__PUBLIC__/images/msg_loading_d.gif"/>');
			},
			success:function (result){
				// $(".btn.btn-default"+id).attr('disabled','disabled');
				alert(result.msg);

				// if(result.do == 'yes'){
				// 	alert(result.msg);
				// 	$(".btn.btn-default"+id).removeAttr('disabled');
				// }else{
				// 	$(".btn.btn-default"+id).css('display','none');//隐藏“发送”按钮
				// 	$("#s_record_"+id).css('display','block');
				// 	$("#s_record_"+id).html(result.link);	//IL=20数量
				// }
				// $(".all"+id+" a").html(result.total);	//总数
			},
		    complete:function(){
		      window.location=window.location;       //刷新页面
		    }
		})
	}

	function reload(){
		$.ajax({
			url:'{:U('LogisticsNode/reloadNums')}',
			type:'post',
			dataType:'json',
			data:'',
			beforeSend:function(){
				$("#rest_num").html('正在查询...');
			},
			success:function(result){
				$("#rest_num").html(result.nums);
			}
		})
	}
</script>
</form>

				<div id="pages" class="page">{$page}</div>
        	</div>
        </div>
		</div>		
<div class="foot"></div>

</block>


</body>
</html>