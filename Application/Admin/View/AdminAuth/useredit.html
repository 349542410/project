<extend name="./base" />

<block name="main">

    <div class="container">
        <div class="col-md-2">
			<include file="Public:authNav" />
        </div>
        <div class="col-md-10">
        	<div class="rtop">
        		<ul class="list-inline">
 				 <if condition="ACTION_NAME eq 'useredit'">
 				 		<li class="blue"><a href="{:U('AdminAuth/index_authNav')}">用户列表</a></li>
 				 </if>
 				 <li style="float:right">您当前所在位置：权限管理&nbsp;/&nbsp;<a href="javascript:void(0);" class="color">用户角色添加</a></li>
				</ul>
        	</div>


			<div class="panel panel-default">
				<div class="panel-heading">
					<h4 class="panel-title">用 户 角 色 添 加</h4>
				</div>

				<div class="panel-body">
					<form class="form-horizontal" action="{:U('AdminAuth/usergroup')}" method='post' id="">
						<div class="form-group">
							<label for="username" class="col-sm-1 control-label">用户名称:</label>
							<div class="col-sm-1">
								{$res['name']}
							</div>
							<label for="groupName" class="col-sm-2 control-label">所属角色:</label>
							<div class="col-sm-3">
								<select class="form-control group_id" name="group_id">
									<option value="0" group_url="{:U('AdminAuth/useredit', array('uid' => $res['id']))}"    <if condition="$group_id eq 0"  >selected="true" </if>>请选择权限组</option>
									<volist name="data" id="vo">
										<option value="{$vo['id']}" <if condition="$group_id eq $vo['id']">selected="true" </if> onclick="group(this)" group_url="{:U('AdminAuth/useredit', array('uid' => $res['id'], 'group_id' => $vo['id'], 'name' => $vo['title']))}" >{$vo['title']}</option>
									</volist>
								</select>
																
							</div>
							<label for="username" class="col-sm-5 control-label">是否以所属角色为默认勾选:&nbsp;&nbsp;&nbsp;<input name="group_type" type="radio"   class="tstand" <if condition="$_GET['group_type'] eq 1">checked="checked" </if>   onclick="stands(this)"  value="1">是&nbsp;&nbsp;&nbsp; <input name="group_type" type="radio" value="0" class="fstand"  <if condition="$_GET['group_type'] eq 0">checked="checked"  </if>   onclick="standard(this)"  >否 </label> 
						</div>
						
						
<if condition="$group_id">
						<div class="form-group" style="height:380px; overflow:auto;">
	
							<input type="hidden"  name="group_id" value="{$group_id}" />
	
							<style type="text/css">
							ul{list-style:none;padding:0;}
							#menu .tree1{padding:14px 14px 14px 39px;color:#6F93FF;font-size:16px;font-family:"黑体";border-bottom:solid 1px #eee;}
							#menu #tree_root{overflow:auto;}
							#menu #tree_root li span{display:block;height:35px;line-height:24px;color:#222;cursor:pointer;}
							#menu #tree_root li span.tree2{padding:6px 6px 6px 20px;}
							#menu #tree_root li span.tree3{padding:6px 6px 6px 34px;}
							#menu #tree_root li span.tree4{padding:6px 6px 6px 48px;}
							#menu #tree_root li span.tree5{padding:6px 6px 6px 62px;}
							#menu li .hover,#menu li span:hover{background-color:#e9edf6;}
							#menu ul{overflow:hidden;}
							#menu ul li b{font-weight:normal;position:relative;padding-left:16px;}
							#menu ul li b:before{display:block;font-size:0;top:5px;left:0;content:"";width:4px;height:4px; border:solid 1px transparent;transform:rotate(45deg);-o-transform:rotate(45deg);-ms-transform:rotate(45deg);-moz-transform:rotate(45deg);-webkit-transform:rotate(45deg);position:absolute;}
							#menu ul li .On:before,#menu ul li .On2Off:before{top:3px;border-bottom-color:#999;border-right-color:#999;}
							#menu ul li .Off:before{top:5px;border-top-color:#999;border-right-color:#999;}
							#menu ul li .On2Off:before{transform:rotate(0deg);-o-transform:rotate(0deg);-ms-transform:rotate(0deg);-moz-transform:rotate(0deg);-webkit-transform:rotate(0deg);}
							
							</style>
							<script type="text/javascript" src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
							<script type="text/javascript">
							$(function(){
								//目录树折叠按钮 -------------------------------
								function setTreeStyle(obj){
									var objStyle = obj.children("b");
									var objList = obj.siblings("ul");
									if(objList.length == 1){
										var style = objStyle.attr("class");
										objStyle.attr("class","On2Off");
										setTimeout(
											function(){
												if(style == "Off"){
													objList.parent().siblings("li").children("span").children(".On").each(function(){
														setTreeStyle($(this).parent());	
													});
													var H = objList.innerHeight()
													objList.css({display:"block",height:"0"});
													objList.animate({height:H},300,function(){$(this).css({height:"auto"});});
													objStyle.attr("class","On");
												}
												else if(style == "On"){
													objList.find("li").children("span").children(".On").each(function(){
														setTreeStyle($(this).parent());	
													});
													var H = objList.innerHeight()
													objList.animate({height:0},300,function(){$(this).css({height:"auto",display:"none"})});
													objStyle.attr("class","Off");
												}
											},
											42
										);
									}
								}
								$("#tree_root").find("li").children("span").click(function(){
									setTreeStyle($(this));
								});
								// -----------------------------------------	
							})
							
							</script>
							<div id="menu">
							    <ul id="tree_root">
							    	<volist name="result" id="vo">
								        <li>
								            <span class="tree2"><b class="On"><input type="checkbox" <if condition="array_intersect($vo['default'], $ruleid)">checked="checked"</if>  data="{$vo['modules']['id']}" onclick="ruleAll(this)" >{$vo['modules']['ModulesName']}</b></span>
								            <notempty  name="vo['rule']">
								            	<ul style="display: block; height: auto;">
								            		<volist name="vo['rule']" id="rules">
								            			<li>
										                   <span class="tree3"><b class="On"><input type="checkbox" name="rule[]" <if condition="in_array($rules['id'], $ruleid)">checked="checked"</if> value="{$rules['id']}"><a onclick="current(this)">{$rules['title']}</a></b></span>
										                </li>    
								            		</volist>
								            	</ul>
								            </notempty>
									            <ul style="display: block; height: auto;">
									            	<volist name="vo['subclass']" id="sub">
									            		
										                <li>
										                    <span class="tree3"><b class="On"><input type="checkbox" <if condition="array_intersect($sub['default'], $ruleid)">checked="checked"</if>  data="{$sub['modules']['id']}" onclick="ruleAll(this)" >{$sub['modules']['ModulesName']}</b></span>
	
	
										                    <ul style="display: block; height: auto;">
										                      
										                       
															<notempty  name="sub['rule']">
																
													            	<php>
													            			foreach($sub['rule'] as $rule){
													            				echo '<li>';
													            				echo '<span class="tree3"><b class="On"><input type="checkbox"  name="rule[]" ';
													            				if(in_array($rule['id'], $ruleid)){ 
													            					echo 'checked="checked"';
													            				};
													            				echo 'value="'.$rule['id'].'">';
													            				//echo $rule['title'];
													            				echo '<a onclick="current(this)">' . $rule['title'] . '</a>';
													            				echo '</b></span>';
													            				echo '</li>';
													            			}
													            		
													            	</php>
												            </notempty>									                      
										                      
										                      
										                        <php> 
											                        foreach($sub['subclass'] as $subc){
											                       			 
												                        echo '<li>'; 
												                        echo '<span class="tree4"><b class="On">';
																		echo '<input type="checkbox" ';
																		if(!empty(array_intersect($subc['default'], $ruleid))){
																			echo 'checked="checked"';
																		}
																		echo 'data="'.$subc['modules']['id'].'" onclick="ruleAll(this)" >';
												                        echo $subc['modules']['ModulesName'] ;
												                        echo '</b></span>';
												                        echo '<ul style="display: block; height: auto;">';
												                       
												                        foreach($subc['rule'] as $r){
												                       		echo '<li><span class="tree5"><b>';
												                        	echo '<input type="checkbox" name="rule[]" value="'.$r['id'].'"';
												                        	if(in_array($r['id'], $ruleid)){ 
														            			echo 'checked="checked"';
														            		};
												                        	echo '>'; 
												                        	//echo $r['title'];
												                        	echo '<a onclick="current(this)">' . $r['title'] . '</a>';
												                        	echo '</b></span></li>';
												                        }
												                        
												                        echo '</ul>';
												                        echo '</li>';
												                        
												                   }
											                   </php>
										                       
										                    </ul>								                    
										                </li>      
									        		</volist>
									            </ul>
								           
								        </li>
							        </volist>
							    </ul>
							</div>						
							
				
						</div>							








</if>

						

						<div class="form-group">
							<label class="col-sm-2 control-label"></label>
							<div class="col-sm-10">
								<button type="button"  onclick="fromdata(this)" class="btn btn-success btn-add">更新</button>
								<input type="hidden"  name="id" value="{$res['id']}" />
								<input type="hidden" name="validate" value="11">
								<span id="messagebox" class="msgbox" style="right:300px;!important"></span>
							</div>
						</div>

					</form>
				</div>
			</div>

        </div>
	</div>	

<div class="foot"></div>
<script type="text/javascript">

	function ruleAll(obj){

		var judge = $(obj).is(":checked");
		var data = $(obj).attr('data');
		var className = 'auth_' + data;
		$(obj).parent().parent().parent().attr('class', className);
		$("."+className+" input[type='checkbox']").each(function(){
		    //alert($(this).val());
			//alert('43656');
			//var rule = $(this).attr('class');
			if(judge){
				//alert('sdfvgdf');
				//$('.'+rule+'').attr('checked', 'checked');
				//$('.'+rule+'').checked = true;
				$(this).prop("checked", 'checked');
				//$(this).checked = true;
			}else{
				//alert('324');
				//$('.'+rule+'').removeAttr('checked');	
				//$('.'+rule+'').checked = false;
				//$(this).attr('checked', ' ');
				$(this).removeAttr('checked');
			}
			
		});
		//上一级默认勾选
		var k = 0;
		$(obj).parent().parent().parent().parent().find(':input[type="checkbox"]').each(function(){
			if($(this).is(":checked")){
				k = k + 1;
			}
		});
		if(k > 0){
			$(obj).parent().parent().parent().parent().prev().children().children('input').prop("checked", 'checked');
		}else{
			$(obj).parent().parent().parent().parent().prev().children().children('input').removeAttr("checked");
		}

		//上二级（顶级）默认勾选
		var kk = 0;
		$(obj).parent().parent().parent().parent().parent().parent().parent().find(':input[type="checkbox"]').each(function(){
			if($(this).is(":checked")){
				kk = kk + 1;
			}
		});
		
		if(kk > 1){
			$(obj).parent().parent().parent().parent().parent().parent().prev().children().children('input').prop("checked", 'checked');
		}else{
			$(obj).parent().parent().parent().parent().parent().parent().prev().children().children('input').removeAttr("checked");
		}
		
		 
	}



	function current(obj){

		var curr = $(obj).prev(':input[name="rule[]"]:checked').val();
		if(typeof(curr) == 'undefined'){
			//$(obj).prev(':input[name="rule[]"]').attr('checked', 'checked');
			$(obj).prev(':input[name="rule[]"]').prop("checked", 'checked');
			$(obj).parent().parent().parent().parent().prev().children().children('input').prop("checked", 'checked');
		}else{
			$(obj).prev(':input[name="rule[]"]').removeAttr("checked");
			//$(obj).prev(':input[name="rule[]"]').removeAttr('checked');
		}

		//上一级是否默认选中
		var i = 0;
		$(obj).parent().parent().parent().parent().find(':input[type="checkbox"]').each(function(){
			if($(this).is(":checked")){
				i = i + 1;
			}
			//alert($(this).val());
		});
		
		if(i > 0){
			$(obj).parent().parent().parent().parent().prev().children().children('input').prop("checked", 'checked');
		}else{
			
			$(obj).parent().parent().parent().parent().prev().children().children('input').removeAttr("checked");
		}
		
		//上二级是否默认选中
		var j = 0;
		$(obj).parent().parent().parent().parent().parent().parent().parent().find(':input[type="checkbox"]').each(function(){
			if($(this).is(":checked")){
				j = j + 1;
			}
			//alert($(this).val());
		});		
		
		if(j > 1){
			$(obj).parent().parent().parent().parent().parent().parent().prev().children().children('input').prop("checked", 'checked');
		}else{
			
			$(obj).parent().parent().parent().parent().parent().parent().prev().children().children('input').removeAttr("checked");
		}

		//上三级(顶级)是否默认选中
		var d = 0;
		$(obj).parent().parent().parent().parent().parent().parent().parent().parent().parent().find(':input[type="checkbox"]').each(function(){
			if($(this).is(":checked")){
				d = d + 1;
			}
			//alert($(this).val());
		});		
		
		if(d > 2){
			$(obj).parent().parent().parent().parent().parent().parent().parent().parent().prev().children().children('input').prop("checked", 'checked');
		}else{
			
			$(obj).parent().parent().parent().parent().parent().parent().parent().parent().prev().children().children('input').removeAttr("checked");
		}

		
	}
	function group(obj){
		//var uid = $(obj).attr('uid');
		//var url_a = "{:U('AdminCollectPoint/pointdelete')}";
		var url = $(obj).attr('group_url');

		var group_type = $('input:radio[name="group_type"]:checked').val();
		var numb = url.indexOf('.html');
		//alert(numb);
		//var url_b = url.substring(0,numb);
		var url_a = '/group_type/'+group_type+'';
		url += url_a;
		//alert(url);
		//var del_sn = $(obj).attr('user_name');
		//if(confirm('是否删除揽收点为：'+ del_sn + ' 的信息！')){
			window.location.href=url;
		//} 
	}

	function stands(obj){
		//$('.tstand').attr('checked', 'checked');
		//$('.fstand').removeattr('checked');
		var url = $('.group_id').find('option:selected').attr('group_url');

		//alert('asfddsf');
		if(url != 'undefined'){
		//var t = url.indexOf('group_type/0');
		
			var url_a = '/group_type/1';
			url += url_a;
			//alert(url);
			window.location.href = url;	
			
		//}
        }
	}

	function standard(obj){
		var data = $(obj).val();
		
		if(data == 1){

		}else if(data == 0){
			//$('.fstand').attr('checked', 'checked');
			//$('.tstand').removeattr('checked');
			//url = $('.group_id').val();
			
			var url = $('.group_id').find('option:selected').attr('group_url');
			//alert(url);
			//return
			//var t = url.indexOf('group_type');
			//if(t > 0){
			//	url = url.replace('/group_type/1', '/group_type/0');
			//}else{
				var url_a = '/group_type/0';
				url += url_a;
			//}
			window.location.href = url;				
		}

	} 	

	
	function ityzl_SHOW_LOAD_LAYER(){  
	    return layer.msg('努力中...', {icon: 16,shade: [0.5, '#f5f5f5'],scrollbar: false,offset: '200px', time:100000}) ;  
	}  
	function ityzl_CLOSE_LOAD_LAYER(index){  
	    layer.close(index);  
	}  
	function ityzl_SHOW_TIP_LAYER(str, url = ''){  
	    layer.msg(''+str+'',{time: 2000,offset: '200px'}); 
	    if(url){
	    	window.location = url;
	    }else{
	    	window.location.reload(); 
	    }
	} 
	
function fromdata(obj){

	var str=document.getElementsByName("rule[]");
	var objarray=str.length;
	var chestr="";
	for (i=0;i<objarray;i++)
	{
	  if(str[i].checked == true)
	  {
	   chestr+=str[i].value+",";
	  }
	}
	//alert(chestr);
	//var filest = files[0];
	//var view_to = $(':input[name="view_to[]"]').val();
	var id = $(':input[name="id"]').val();
	var group_id = $(':input[name="group_id"]').val();
	
	var formData = new FormData();
	formData.append("group_id", group_id);
	formData.append("rule", chestr);
	formData.append("id", id);
	
	
	var request;
	if (window.XMLHttpRequest) {
		request = new XMLHttpRequest();
	} else {
	    request = new ActiveXObject('Microsoft.XMLHTTP');
	}
	var i;
	ityzl_SHOW_LOAD_LAYER();
	request.onreadystatechange = function(){
		if(request.status == 200 && request.readyState == 4){
			if(request.responseText){
				//成功返回
				var a = JSON.parse( request.responseText );
				var status = a.status;
				var str = a.data.strstr;
				var url = a.data.url;
				ityzl_CLOSE_LOAD_LAYER(i); 
                ityzl_SHOW_TIP_LAYER(str, url);
                var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
                //var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                parent.layer.msg(str);
                parent.location.reload();	
    			parent.layer.close(index);
    			 
                //parent.layer.close(str); //再执行关闭 
                ityzl_SHOW_TIP_LAYER(str, url);
                //document.getElementById("form2").reset();				
			}else{
				ityzl_CLOSE_LOAD_LAYER(i);
			}
		}
	}
	request.open("post", "{:U('AdminAuth/usergroup')}");
	//request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
	request.setRequestHeader("X-Requested-With","XMLHttpRequest");
	request.send(formData);								
	// 上传代码返回结果之后，将图片插入到编辑器中
	
	
}
	
</script>		
<script src="__PUBLIC__/js/my.js"></script>
</block>

</body>

</html>