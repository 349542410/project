<!doctype html>
<head>
    <meta charset=utf-8>
    <title>证件照上传</title>
<meta http-equiv="pragma" content="no-cache">
<meta http-equiv="cache-control" content="no-cache">
<meta http-equiv="expires" content="0">    
    <style>
        body { width: 800px; margin: 0 auto;}
        form { display: block; margin: 20px auto; background: #eee; border-radius: 10px; padding: 15px ;height: 500px;}
        .progress { position:relative; width:180px; border: 1px solid #ddd; padding: 1px; border-radius: 3px; margin-top:10px;}
        .bar { background-color: #B4F5B4; width:0%; height:20px; border-radius: 3px; }
        .percent { position:absolute; display:inline-block; top:1px; left:43%; }
        .content{width: 300px;margin: 0 auto;margin-top:30px;}
        .content{position:relative;top:2%;left:3%;}
    </style>
    <script src="__PUBLIC__/js/jquery-2.1.4.min.js"></script>
    <script src="__PUBLIC__/js/jquery.form.js"></script>
    <link href="__PUBLIC__/css/buttons.css" rel="stylesheet">
    <script>
      //图片上传预览    IE是用了滤镜。
        function previewImage(file)
        {
          var MAXWIDTH  = 350; 
          var MAXHEIGHT = 350;
          var div = document.getElementById('preview');
          if (file.files && file.files[0])
          {
              div.innerHTML ='<img id=imghead onclick=$("#previewImg").click()>';
              var img = document.getElementById('imghead');
              img.onload = function(){
                var rect = clacImgZoomParam(MAXWIDTH, MAXHEIGHT, img.offsetWidth, img.offsetHeight);
                img.width  =  rect.width;
                img.height =  rect.height;
//                 img.style.marginLeft = rect.left+'px';
                // img.style.marginTop = rect.top+'px';//添加一个外边距
              }
              var reader = new FileReader();
              reader.onload = function(evt){img.src = evt.target.result;}
              reader.readAsDataURL(file.files[0]);
          }
          else //兼容IE
          {
            var sFilter='filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod=scale,src="';
            file.select();
            var src = document.selection.createRange().text;
            div.innerHTML = '<img id=imghead>';
            var img = document.getElementById('imghead');
            img.filters.item('DXImageTransform.Microsoft.AlphaImageLoader').src = src;
            var rect = clacImgZoomParam(MAXWIDTH, MAXHEIGHT, img.offsetWidth, img.offsetHeight);
            status =('rect:'+rect.top+','+rect.left+','+rect.width+','+rect.height);
            div.innerHTML = "<div id=divhead style='width:"+rect.width+"px;height:"+rect.height+"px;margin-top:"+rect.top+"px;"+sFilter+src+"\"'></div>";
          }
        }
        function clacImgZoomParam( maxWidth, maxHeight, width, height ){
            var param = {top:0, left:0, width:width, height:height};
            if( width>maxWidth || height>maxHeight ){
                rateWidth = width / maxWidth;
                rateHeight = height / maxHeight;
                
                if( rateWidth > rateHeight ){
                    param.width =  maxWidth;
                    param.height = Math.round(height / rateWidth);
                }else{
                    param.width = Math.round(width / rateHeight);
                    param.height = maxHeight;
                }
            }
            param.left = Math.round((maxWidth - param.width) / 2);
            param.top = Math.round((maxHeight - param.height) / 2);
            return param;
        }
    </script>
</head>
<body>
<form action="{:U('upLoad')}" method="post" enctype="multipart/form-data" id="myForm">
  <div>
    注意：上传的图片必须是身份证<font color="red">正反面合成</font>的jpg格式的图片（最大 300kb）；
  </div>
  <div class="content">
  <div id="preview">
    <img id="imghead" border="0" src="__PUBLIC__/images/photo_icon.png" width="180" height="180" onClick="$('#previewImg').click();">
  </div>

  <input type="file" name="file" onChange="previewImage(this)" style="display: none;" id="previewImg" accept=".jpg,.png,.jpeg"><br/>
  <input type="submit" value="提交上传" class="button button-primary button-rounded button-small">
  <input type="hidden" value="{:I('id')}" name="id">
  <div class="progress">
      <div class="bar"></div >
      <div class="percent">0%</div >
  </div>
  <div id="status"></div>
  </div>
</form>

<script>

$(function(){


var bar = $('.bar');
var percent = $('.percent');
var status = $('#status');
   
$('form').ajaxForm({
    beforeSerialize:function(){
        //alert("表单数据序列化前执行的操作！");
        //$("#txt2").val("java");//如：改变元素的值
    },
    beforeSubmit:function(){
        //alert("表单提交前的操作");
        var obj_file = document.getElementById("previewImg").value;
        // alert(obj_file);
        if(obj_file == ''){
          alert('请先选择上传文件');
          return false;
        }//如：验证表单数据是否为空

        var filesize = $("input[type='file']")[0].files[0].size;
        if(filesize > 307200){
            alert("文件大小超过限制，最大300kb");
            return false;
        }

    },
    beforeSend: function() {
        status.empty();
        var percentVal = '0%';
        bar.width(percentVal)
        percent.html(percentVal);
    },
    uploadProgress: function(event, position, total, percentComplete) {
        var percentVal = percentComplete + '%';
        bar.width(percentVal)
        percent.html(percentVal);
    //console.log(percentVal, position, total);
    },
    success: function(result) {
        var percentVal = '100%';
        bar.width(percentVal)
        percent.html(percentVal);
        if(result.status == 1){
          status.html('<font color="green">'+result.info+'</font>');
        }else{
          status.html('<font color="red">'+result.info+'</font>');
        }
    },
    complete: function(xhr) {
      $('#myForm').resetForm();
      $('#myForm').clearForm('.special:hidden');
      $('#imghead').attr('src',"__PUBLIC__/images/photo_icon.png");
      $('#imghead').attr('width',"180px");
      $('#imghead').attr('height',"180px");
      // status.html(xhr.info);
    }
});


});
       
</script>