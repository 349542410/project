<!-- 公共部分 数据展示 St2Ems,SfLogistics,Logistics-->
<style>
	dt{padding-top: 5px;text-align: center;}
	.container h3{font-size:26px;}
	.btn{width:58px;height:30px;background-color: #eee;}
	.container .active a{color:black;}
	.container .active{background-color: #cccddd !important;}
	.container table a{}
	.searchbox{width:88%;margin:0 auto;}
</style>

<form action="">
<div class="container" style="">
	<volist name="list" id="vo">
		<div style="width:300px;height:275px;border:1px dotted black;float:left;margin-left:30px;margin-bottom:30px;">
			<div style="">
				<a href="{:U('Logarithm/export',array('id'=>$vo['id']))}" data-toggle="modal" data-target="#myModal">
					<h3 style="text-align: center;" title="中转批号"><strong>{$vo['no']}</strong></h3>
				</a>
				<dt title="中转批号创建时间">{$vo['date']}</dt>
				<dt title="线路名称">{$vo['name']}</dt>
				<dt title="航空单号"><a href="{:U('Logarithm/info',array('id'=>$vo['id']))}" data-toggle="modal" data-target="#myModal">{$vo['airno']}</a></dt>
				<dt title="保存航空号时间">{$vo['airdatetime']}</dt>
				<dt style="">
					<span style="font-size: 15px;padding:0 20px;">
						<span class="weight_num{$vo['id']}" style="font-size: 15px;">
							{$vo['grossweight_kg']}
						</span>
						kg&nbsp;
						<a href="javascript:void(0);" onclick="count_weight('{$vo.id}');">
						<span class="weight_do{$vo['id']}" style="font-size: 15px;">
							<if condition="$vo['grossweight_kg'] eq 0">
								统计
								<else />
								刷新
							</if>
						</span>
						</a>
					</span>
					<span style="font-size: 15px;padding:0 20px;">
						<span class="twn{$vo.id}">
						<if condition="$vo['twn'] eq 0">
							<span style="font-size: 15px;">已完成</span>
						<else />
							<a target="_blank" href="{:U('PostManagement/showList',array('mstr'=>$vo['no'],'stype'=>'miss','id'=>$vo['id'],'tcid'=>$vo['tcid']))}">{$vo['twn']}</a>
						</if>
						<!-- </span> / <span class="all{$vo.id}">{$vo['all']}</span> -->
						</span> / <span class="all{$vo.id}"><a target="_blank" href="{:U('PostManagement/showList',array('mstr'=>$vo['no'],'stype'=>'normal','id'=>$vo['id'],'tcid'=>$vo['tcid']))}">{$vo['all']}</a></span>
					</span>
				</dt>
				<!-- 大于10的才显示刷新按钮 -->
				<if condition="$vo.status gt 10">
					<dt>
						<button type="button" class="btn btn-default{$vo['id']}" onclick="reflash('{$vo.id}');">刷新</button>
						<span class="loading{$vo['id']}"></span>
					</dt>
				</if>
			</div>
		</div>	
	</volist>
</div>
<script>
	function reflash(id){
		$.ajax({
			url:"{:U('Logarithm/reflash')}",
			type:'post',
			dataType:'json',
			data:{
				'id':id,
			},
			beforeSend:function(){
				$(".btn.btn-default"+id).html('<img style="width:18px;height:18px;" src="__PUBLIC__/images/msg_loading_d.gif"/>');
				// $(".loading"+id).html('&nbsp;<img style="width:20px;height:20px;" src="__PUBLIC__/images/msg_loading_d.gif"/>');
			},
			success:function (result){
				// $(".loading"+id).html('&nbsp;<img style="width:20px;height:20px;" src="__PUBLIC__/images/success.png"/>');
				$(".btn.btn-default"+id).attr('disabled','disabled');
				if(result.twn != '0'){
					$(".twn"+id+" a").html(result.twn);	//IL=20数量
				}else{
					$(".twn"+id).html('<span style="font-size: 15px;">已完成</span>');	//IL=20数量
				}
				$(".all"+id+" a").html(result.total);	//总数
				var t = result.timeout;	//倒数时间
				showTime(id,t,result.twn);	//倒计时
			}
		})
	}

	function count_weight(id){
		$.ajax({
			url:"{:U('Logarithm/count_weight')}",
			type:'post',
			dataType:'json',
			data:{
				'id':id,
			},
			beforeSend:function(){
				$(".weight_do"+id).html('<img style="width:18px;height:18px;" src="__PUBLIC__/images/msg_loading_d.gif"/>');
			},
			success:function (result){
				$(".weight_do"+id).attr('disabled','disabled');
				if(result.grossweight_kg != '0'){
					$(".weight_do"+id).html('刷新');
				}else{
					$(".weight_do"+id).html('统计');
				}
				$(".weight_num"+id).html(result.grossweight_kg);	//总重量
			}
		})
	}

function showTime(id,t,twn){
    $(".btn.btn-default"+id).html(t);
    t--;
    //当=0的时候，终止自动刷新
    if(twn == 0){
        // $(".btn.btn-default"+id).removeAttr('disabled');
        $(".btn.btn-default"+id).html("刷新");
        return false;
    }
    if(t < 0){
    	$(".btn.btn-default"+id).html("刷新");
    	$(".btn.btn-default"+id).click();	//模拟点击，以便继续自动刷新
    	return false;
    }
    //每秒执行一次,showTime()
    setTimeout("showTime("+id+","+t+")",1000);
}

// 20160113 另一个刷新类型
// function showTime(id,t){
//     $(".btn.btn-default"+id).html(t);
//     t--;
//     if(t < 0){
//         $(".btn.btn-default"+id).removeAttr('disabled');
//         $(".btn.btn-default"+id).html("刷新");
//         return false;
//     }
//     //每秒执行一次,showTime()
//     setTimeout("showTime("+id+","+t+")",1000);
// }
</script>

</form>