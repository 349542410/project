<extend name="base" />

<html>
<block name="content">
<load href="__PUBLIC__/css/record.css" />
<script type="text/javascript" src="__PUBLIC__/js/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="__PUBLIC__/js/jquery.form.js"></script>
<div class="content">
<div class="formbox">
	<if condition="isset($tips)">
		<div align="center">
			<img style="width:25px;height:25px;vertical-align: middle;" src="__PUBLIC__/images/signal-attention.png"/>{$tips}<br>
			<a href="{$url}">
			<if condition="$swit eq 2">
				<button type="button" style="width:70px;">返回</button>
			<elseif condition="$swit eq 1"/>
				<button type="button" style="width:70px;">查看物流</button>
			</if>
			</a>
		</div>
	<else />
	<div class="flow_steps">
		<ul>
			<li id="kjxx" class="current">快件信息</li>
			<li id="zjxx">身份证信息</li>
			<li id="finished" class="last">完成</li>
		</ul>
	</div>
	<div class="formcon">
		<div id="one">
			<form action="{:U('Index/step_one')}" method="post" id="step_one">
			<table align="center">
				<tr>
					<td width="140px">美快单号：<input class="pwdTrigger" type="text" id="mkno" name="order_no" required <if condition="$order_no">value="{$order_no}"<else />placeholder="请输入美快单号" value="{$res['order_no']}"</if> /></td>
				</tr>
				<tr>
					<td >收件人：<input class="pwdTrigger" type="text" id="rec" name="rec" placeholder="请输入收件人" value="{$res['receiver']}" required/></td>
					<td></td>
				</tr>
				<tr>
					<td >收件人电话：<input class="pwdTrigger" type="text" id="phone" name="phone" placeholder="请输入收件人电话" value="{$res['reTel']}" required/></td>
					<td></td>
				</tr>
				<tr>
					<td>
						<button type="submit" >提交</button>
						<span id="msg_one"></span>
					</td>
				</tr>
			</table>
			</form>
		</div>
		<div id="two" style="display:none">
			<form action="{:U('Index/step_two')}" method="post" id="step_two" enctype="multipart/form-data">
			<table align="center">
                <tr>
                    <td>订单号：<br>
                        <label id="order_no"></label>
                    </td>
                </tr>
                <tr>
                    <td>姓名：<br>
                        <label id="rel_name"></label>
                    </td>
                </tr>
                <tr>
                    <td>手机号码：<br>
                        <label id="tel_no"></label>
                    </td>
                </tr>
                <tr>
					<td width="140px">身份证号：
						<input class="pwdTrigger" onkeypress="uniCharCode(event)" type="text" id="cnumber" name="cnumber" placeholder="请输入身份证号码" required />
					</td>
				</tr>
                <tr>
                    <td width="140px">上传证件头像面照：<a href="{:U('Index/explainImg')}"><img style="width:15px;height:18px;vertical-align: middle;" src="__PUBLIC__/images/wenzi.png"/></a><input name="file_two" id="files" type="file" accept="image/jpg"></td>

                </tr>
                <tr>
					<td width="140px">上传证件国徽面照：<input name="file_one" id="file" type="file" accept="image/jpg"></td>

				</tr>
				<tr>
					<td>
						<input type="hidden" name="user_id" value="">
						<input type="hidden" name="receiver" value="">
						<input type="hidden" name="sid" value="">
						<input type="hidden" name="order_no" value="">
						<input type="hidden" name="mkno" value="">
						<input type="hidden" name="b" value="">
						<input type="hidden" name="f" value="">
						<input type="hidden" name="sb" value="">
						<input type="hidden" name="sf" value="">
						<button type="button" onclick="reone()">上一步</button>&nbsp;&nbsp;&nbsp;&nbsp;
						<button type="submit" onclick="">提交</button>
						<span id="msg_two"></span>
					</td>
				</tr>
			</table>
			</form>
		</div>
		<div id="three" style="display:none">
			<div align="center">
				<div id="success_msg"></div>
				<div id="search_url"><a href=""><button type="button" style="width:70px;">查看物流</button></a></div>
			</div>
		</div>
	</div>
	</if>
</div>
</div>
<script type="text/javascript">
function reone() {
	if (confirm("确定返回？")) {
		$("#one").show();
		$("#two").hide();
		$("#kjxx").attr("class","current");
		$("#zjxx").attr("class","");
	}
}
</script>
<script>

$(function(){

  	$('#step_one').ajaxForm({
	    beforeSubmit: checkOne, 
	    dataType: 'json',
	    success: function(result){
			if(result.status == 1){
				// 身份证号码赋值
				$("input[name='cnumber']").val(result.idno);
				$("#one").hide();
				$("#two").show();
				$("#kjxx").attr("class","current_prev");
				$("#zjxx").attr("class","current");
				$("#msg_one").html('');
				$("input[name='sid']").val(result.sid);
				$("input[name='order_no']").val(result.order_no);
				$("input[name='receiver']").val(result.receiver);
				$("input[name='user_id']").val(result.user_id);
				$("input[name='mkno']").val(result.MKNO);
				$("input[name='b']").val(result.b);
				$("input[name='f']").val(result.f);
				$("input[name='sb']").val(result.sb);
				$("input[name='sf']").val(result.sf);
                $("#order_no").text(result.order_no);
                $("#rel_name").text(result.receiver);
                $("#tel_no").text(result.reTel);
			}else if(result.status == 400){
				$("#one").hide();
				$("#three").show();
				$("#kjxx").attr("class","done");
				$("#zjxx").attr("class","current_prev");
				$("#finished").attr("class","current last");
				$("#msg_two").html('');
				$("#success_msg").html('<img style="width:25px;height:25px;vertical-align: middle;" src="__PUBLIC__/images/signal-attention.png"/>&nbsp;'+result.msg);
				$("#search_url a").attr('href',result.url);
			}else{
				$('#msg_one').html('');
				alert(result.msg);
			}
		}
  	});
  
  	function checkOne(){
	    if($('#mkno').val() == ''){
	    	alert('请输入美快单号');
	    	return false;
	    }
	    if($('#rec').val() == ''){
	    	alert('请输入收件人');
	    	return false;
	    }
	    if($('#phone').val() == ''){
	    	alert('请输入收件人电话');
	    	return false;
	    }
	    $("#msg_one").html('&nbsp;<img style="width:20px;height:20px;vertical-align: middle;" src="__PUBLIC__/images/msg_loading_d.gif"/>');
  	}

    $('#step_two').ajaxForm({
	    beforeSubmit: checkTwo, 
	    dataType: 'json',
	    success: function(result){
			$("#msg_two").html('');
			if(result.status == 1){
				$("#two").hide();
				$("#three").show();
				$("#kjxx").attr("class","done");
				$("#zjxx").attr("class","current_prev");
				$("#finished").attr("class","current last");
				$("#success_msg").html('<img style="width:25px;height:25px;vertical-align: middle;" src="__PUBLIC__/images/dui.png"/>&nbsp;'+result.msg);
				$("#search_url a").attr('href',result.url);
			}else if(result.status == 400){
				$("#two").hide();
				$("#three").show();
				$("#kjxx").attr("class","done");
				$("#zjxx").attr("class","current_prev");
				$("#finished").attr("class","current last");
				$("#success_msg").html('<img style="width:25px;height:25px;vertical-align: middle;" src="__PUBLIC__/images/signal-attention.png"/>&nbsp;'+result.msg);
				$("#search_url a").attr('href',result.url);
			}else{
				alert(result.msg);
			}
		}
  	});
//	$("#cnumber").on("input",function(){
//		var val=$(this).val().replace(/\s/g,"").replace(/(\d{4})/g,"$1 ");
//		$(this).val(val);
//	});
  	function checkTwo(){
	    if($('#cnumber').val() == ''){
	    	alert('请输入身份证号码');
	    	return false;
	    }
		var reg = /(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/;
		if(reg.test($('#cnumber').val()) === false)
		{
			alert("身份证格式不对");
			return false;
		}
//		$(document).ready(function () {
//			$('#cnumber').on('keyup mouseout input', function () {
//				var $this = $(this);
//				var v = $this.val();
//				/\S{5}/.test(v) && $this.val(v.replace(/\s/g, '').replace(/(.{4})/g, "$1 "));
//			});
//		})
//		var reg = /(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/;
//		if(!reg.test($('#cnumber').val)){
//			alert("身份证号填写有误");
//			return false;
//		}
	    $("#msg_two").html('&nbsp;<img style="width:20px;height:20px;vertical-align: middle;" src="__PUBLIC__/images/msg_loading_d.gif"/>');
  	}
});
</script>
</block>
</html>