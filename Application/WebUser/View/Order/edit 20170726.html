<!-- 在线下单 -->
<extend name="Member/base" />


<block name="main">
<script type="text/javascript" src="__MEMBER__/js/city/jquery.js"></script>
<script type="text/javascript" src="__MEMBER__/js/city/area.js"></script>
<script type="text/javascript" src="__MEMBER__/js/city/location.js"></script>
<script type="text/javascript" src="__MEMBER__/js/city/select2.js"></script>
<script type="text/javascript" src="__MEMBER__/js/city/select2_locale_zh-CN.js"></script>
<script src="__MEMBER__/js/cityselected.js"></script>
<link href="__MEMBER__/css/select2.css" rel="stylesheet"/>
<link rel="stylesheet" type="text/css" href="__APPWX__/css/order.css">
	<div class="form form_index" >
     <div class="form-signin" style="width:100%;min-height:500px;margin:0 auto;padding:0;">
	    <form action="<eq name="step" value="">{:U('Order/saveEdit')}<else/>{:U('Order/step_two')}</eq>" method="post" class="form-inline" id="tempForm">
	    	<div class="ordtop">
		    	<!-- **************************************************** -->
	    		<!-- 寄件人信息 -->
		    	<div class="ordsender">
		    		<h4>{:L('SenderInfo')}</h4>
		    		<ul>
		    			<li><label>{:L('FullName')}：</label><input type="text" value="{$info['sender']}" name="PostName" required oninvalid="setCustomValidity('请输入寄件人！');" oninput="setCustomValidity('');" ></li>
		    			<li><label>{:L('Address')}：</label><input type="text" value="{$info['sendAddr']}" name="PostAddress" required oninvalid="setCustomValidity('请输入寄件人地址！');" oninput="setCustomValidity('');"></li>
		    			<li><label>{:L('Phone')}：</label><input type="phone" value="{$info['sendTel']}" name="PostPhone" required oninvalid="setCustomValidity('请输入寄件人电话！');" oninput="setCustomValidity('');"></li>
		    			<li><label>{:L('ZipCode')}：</label><input type="text" value="{$info['postcode']}" name="PostCode" required oninvalid="setCustomValidity('请输入寄件人邮编！');" oninput="setCustomValidity('');"></li>
		    		</ul>
		    	</div>
		    	<!-- **************************************************** -->
	    		<!-- 收件人信息 -->
		    	<div class="ordrec">
		    		<h4>{:L('RecInfo')}</h4>
		    		<ul>
		    			<li><label>{:L('FullName')}：</label><input type="text" value="{$info['receiver']}" name="RecName" required oninvalid="setCustomValidity('请输入收件人！');" oninput="setCustomValidity('');">
		    			</li>
		    			<li>
		    				<label>{:L('DocumentsType')}：</label>
		    				<select name="Id_tpye">
		    					<volist name="ID_TYPE" id="ty">
		    						<option value="{$key}" <if condition="($info['idkind'] eq $key)">selected</if>>{:L($ty)}</option>
		    					</volist>
		    				</select>
		    				<input type="text" name="IdNo" value="{$info['idno']}" required oninvalid="setCustomValidity('请输入证件号码！');" oninput="setCustomValidity('');" style="width:41% !important">
		    			</li>
		    			<li class="addres">
		    				<label>{:L('Address')}：</label>
		    				<select id="loc_province" style="width:85px;" >
						    </select>
						    <select id="loc_city" style="width:85px; margin-left: 5px" >
						    </select>
						    <select id="loc_town" style="width:100px;margin-left: 5px" >
						    </select>
						    <input id="province" name="Province" value="{$info['province']}" style="display:none" />
						    <input id="city" name="City" value="{$info['city']}" style="display:none" />
						    <input id="town" name="Town" value="{$info['town']}" style="display:none" />
		    			</li>
		    			<li><label>{:L('DetaileAddress')}：</label><input type="text" value="{$info['reAddr']}" name="RecAddress" required oninvalid="setCustomValidity('请输入详细地址！');" oninput="setCustomValidity('');"></li>
		    			<li><label>{:L('Phone')}：</label><input type="text" value="{$info['reTel']}" name="RecPhone" required oninvalid="setCustomValidity('请输入收件人电话！');" oninput="setCustomValidity('');"></li>
		    			<li><label>{:L('ZipCode')}：</label><input type="text" value="{$info['postcode']}" name="RecCode" required oninvalid="setCustomValidity('请输入收件人邮编！');" oninput="setCustomValidity('');"></li>
		    		</ul>
		    	</div>
		    	<div class="clear"></div>
		    </div>
<!-- **************************************************** -->
	    	<!-- 选择线路 -->
	    	<div class="ordhead"><h3>{:L('SelectLine')}</h3></div>
	    	<div class="ordbody">
		    	<table class="tab1" border="0" cellpadding="0" cellspacing="0">
				    <tr>
						<td class="tdleft"><label>{:L('TranLine')}：</label></td>
						<td>
						<label>
		                <select name="TransferLine" id="TransferLine" class="form-control" required>
							<option value="{$vo['id']}">{:L('PleaseSelectLine')}</option>
							<volist name="tranline" id="vo">
								<option value="{$vo['id']}" <if condition="($info['TranKd']) eq $vo['id']">selected</if>><php>$l = L('MKLINES');echo $l[$vo['lngname']];</php></option>
							</volist>
		<!-- 					<option value="1" <if condition="($info['TranKd']) eq '1'">selected</if>><php>$l = L('MKLINES');echo $l[1];</php></option>
							<option value="2" <if condition="($info['TranKd']) eq '2'">selected</if>><php>$l = L('MKLINES');echo $l[2];</php></option> -->
		                </select>
						</label>
						</td>
		            </tr>
		            <table><p id="mimenu"></p></table>
					<ul style="display:none;">
						<volist name="tranline" id="vo">
							<li class="m{$vo['id']}"><php>$l = L('MKRemarks');echo $l[$vo['lngremark']];</php></li>
						</volist>
					</ul>
				</table>
	    	</div>
<!-- **************************************************** -->
			<!-- 货品声明 -->
			<div class="ordhead"><h3>{:L('GoodsList')}</h3></div>
				<div class="ordrec col-xs-12 col-sm-6">
					<input type="hidden" id="num" value="{$numc}" autocomplete="off">
					<for start="0" end="$count">
						<ul id="table">
							<li><label>{:L('BrandName')}：</label><input type="text" name="brand_{$i}" value="{$pro_list[$i]['brand']}" class="clchang"></li>
							<li><label>{:L('ProductName')}：</label><input type="text" name="product_{$i}" value="{$pro_list[$i]['detail']}" class="clchang"></li>
							<li><label>{:L('ProCate')}：</label><input type="text" name="catname_{$i}" value="{$pro_list[$i]['catname']}" class="clchang"></li>
							<li class="ordkpmid"><label>{:L('Customs')}</label><br><label>---</label></li>
							<li class="flaotl ordsmli"><label>{:L('Amount')}</label><input type="text" name="amount_{$i}" value="{$pro_list[$i]['number']}" class="clzhong"></li>
							<li class="flaotl ordsmli"><label>{:L('UnitPrice')}</label><input type="text" name="price_{$i}" value="{$pro_list[$i]['price']}" class="clzhong"></li>
							<li class="flaotl ordsmli">
								<label>{:L('Currency')}</label>
								<select name="coin_{$i}" id="" class="clduan">
									<!-- <option value=""></option> -->
									<option value="CNY" selected="selected">￥</option>
									<!-- <option value="USD">$</option> -->
								</select>
							</li>
							<li class="flaotl ordsmli"><label>{:L('Remarks')}</label><input type="text" name="remark_{$i}" dd="{:L('Remarks')}" class="clzhong"></li>
							<div style="clear: both;"></div>
							<li class="ordbtn"><a onclick="copy_row(this)" href="javascript:void(0)">+</a></li>
							<span class="forspan">{:L('Notice')}</span>
						</ul>
					</for>
				</div>
			<!-- 按钮部分 -->
	    	<table style="width: 100%;float: right;margin: 0 5%;">
					<tr>
				<td>
					<input type="hidden" value="{$id}" name="lid">
					<input type="hidden" value="{$info['random_code']}" name="uucode">
					<input type="hidden" value="{$info['order_no']}" name="sn">
				</td>
				<td style="text-align: right;">
					<span id="loading" style="bottom:180px;left:650px;!important"></span>
					<button type="button" class="btn" id="BtnSave">{:L('BtnSave')}</button>
					<!-- <button type="button" class="btn btn-default" data-dismiss="modal" id="beClosed">关闭</button> -->
					<span id="messagebox" class="msgbox" style="bottom:180px;left:650px;!important"></span>
				</td>
					</tr>
			</table>
			<!-- END -->
	    	<div style="clear:both;"></div>
		</form>
    </div>
   	</div>
	<eq name="step" value="">
		<script type="text/javascript" src="__MEMBER__/js/jquery.form.js"></script>
		<script type="text/javascript">
			// 返回修改的ajax请求 
			$(document).ready(function(){
				$('#tempForm').ajaxForm({
					beforeSubmit: checkForm, 
					success: complete,
					error: error,
					dataType: 'json',
					timeout : 0,
				});
				function checkForm(){
					// $("#loading").html('<img style="width:28px;height:28px;" src="__MEMBER__/images/msg_loading_d.gif"/>');
				}
				function complete(data){
					if(data.state == 'yes'){
						$("#loading").html('');
						layer.open({
							closeBtn:0,
							type: 0,
							offset: '300px',
							shadeClose: true,
							title : "{:L('LAY_SystemMessage')}",
							content : data.msg,
							icon : 1,
							btn: ["{:L('LAY_BtnOK')}"],
							yes:function(){
								window.location.href=data.url;
							},
						});
					    
					}else{
					    layer.alert(data.msg, {icon: 2,time: 2000,btn: ["{:L('LAY_BtnOK')}"]});
					}
				}
				function error(){
					$("#loading").html('');
					layer.msg("{:L('LAY_ErrorMsg')}", {icon: 0,time: 1500});
				}
			});
		</script>
	</eq>
<script type="text/javascript">
	// 这是后台返回的省市区，把它们都分别赋值到那三个select上面显示
	$(function(){	
		var p = "{$info['province']}";
		var c = "{$info['city']}";
		var t = "{$info['town']}";
		$("#select2-chosen-1").html(p);
		$("#select2-chosen-2").html(c);
		$("#select2-chosen-3").html(t);
	});

	// 选择线路特效
	$(document).ready(function(){
		var p2 = $('#TransferLine').children('option:selected').val();//这就是selected的值
		if(p2 != ''){
			$("#mimenu").html('说明：'+$(".m"+p2).html());
		}
		
		$('#TransferLine').change(function(){
			var p = $(this).children('option:selected').val();//这就是selected的值

			if(p != ''){
				var h = $(".m"+p).html();
				$("#mimenu").html('说明：'+h);
			}else{
				$("#mimenu").html('');
			}
		})
	});

	// 修改弹出框，使用layer 20170315 gan
	$('#BtnSave').click(function(){
	    $.ajax({
	        cache: false,
	        type: "post",
	        url:"{:U('Order/saveEdit',array('type'=>'checkForm','step'=>$step))}",
	        data:$('#tempForm').serialize(),// formid
	        async: false,
	        beforeSend:function(){
	            $("#loading").html('<img style="width:28px;height:28px;" src="__MEMBER__/images/msg_loading_d.gif"/>');
	        },
	        error: function(request) {
	            layer.msg("{:L('LAY_ErrorMsg')}", {icon: 0,time: 1500});
	            $("#loading").html('');
	        },
	        success: function(data) {
	            if(data.state == 'no'){
	            	layer.alert(data.msg, {icon: 2,time: 2000,btn: ["{:L('LAY_BtnOK')}"]});
	                $("#loading").html('');

	            }else{
	                $('#BtnSave').attr('type','submit');
	                $("#loading").html('');
	            }
	        }
	    });
	});

	// 货品声明 删除行效果    
	$(function(){
		$("td.nows a").css('display','none');
		$(".stta").hover(function(){
			var ttc= $(this).find('.ttc').attr('value');
			var src= $(this).find('img');
			if(ttc!=''){
				var d=$(this);
				$(this).find('.nows').find('a').css('display','inline');
				$(this).find('.nows').find('a').click(function(){
					layer.confirm("{:L('LAY_MesDel')}", {icon:3,offset: '300px',btn:["{:L('LAY_BtnOK')}","{:L('LAY_BtnCancel')}"],title:"{:L('LAY_Information')}",}, function(){
						$.ajax({
							url: "{:U('Order/del')}",
							type: "POST",
							data:{'ttc':ttc,},
							dataType: "json",
							success:function(result){
				   				if(result.state == '1'){
				   					layer.msg(result.msg, {icon: 6,offset: '350px'});
				   					d.find('input').attr('value','');
									d.find('select').val('1');
									src.remove();
				   				}else{
									layer.open({
										type: 0,
										title : "{:L('LAY_SystemMessage')}",
										content : result.msg,
										icon : 5,
										offset: '300px',
										btn:"{:L('LAY_BtnOK')}",
									});
									src.attr('src',"__MEMBER__/images/clean.png");
				   				}
				   				d.find('.nows').find('a').css('display','none');
				   			}
						});
					});					
				})
			}		 
		},function(){
			$(this).find('.nows').find('a').css('display','none');	
			$(this).find('.nows').find('a').unbind();
		})
	});
	
	// 添加删除行 20170316 gan
	function copy_row(obj)
	{
		var num=$("#num").val();
		num++;
		if(num>=9){
			layer.open({
				title:"{:L('LAY_SystemMessage')}",
				offset: '300px',
				icon : 0,
				content: "{:L('LAY_AddRow')}",
			});
			$('.copy_r').find('a').remove();
		var str='<li><label>{:L("BrandName")}：</label><input type="text" name="brand_'+num+'" value="{$pro_list['+num+']["brand"]}" class="clchang"></li><li><label>{:L("ProductName")}：</label><input type="text" name="product_'+num+'" value="{$pro_list['+num+']["detail"]}" class="clchang"></li><li><label>{:L("ProCate")}：</label><input type="text" name="catname_'+num+'" value="{$pro_list['+num+']["catname"]}" class="clchang"></li><li class="ordkpmid"><label>{:L("Customs")}</label><br><label>---</label></li><li class="flaotl ordsmli"><label>{:L("Amount")}</label><input type="text" name="amount_'+num+'" value="{$pro_list['+num+']["number"]}" class="clzhong"></li><li class="flaotl ordsmli"><label>{:L("UnitPrice")}</label><input type="text" name="price_'+num+'" value="{$pro_list['+num+']["price"]}" class="clzhong"></li><li class="flaotl ordsmli"><label>{:L("Currency")}</label><select name="coin_'+num+'" id="" class="clduan"><option value="CNY" selected="selected">￥</option></select></li><li class="flaotl ordsmli"><label>{:L("Remarks")}</label><input type="text" name="remark_'+num+'" dd="{:L("Remarks")}" class="clzhong"></li><div style="clear: both;"></div><li class="ordbtn"><a onclick="copy_row(this)" href="javascript:void(0)">+</a></li><span class="forspan">{:L("Notice")}</span>';
		$("#table").append(str);
		$("#num").val(num);
	}
</script>
<!-- END -->
	<div class="foot"></div>

</block>

</body>
</html>