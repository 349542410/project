<!-- 在线下单 -->
<extend name="Member/base" />


<block name="main">
<script type="text/javascript" src="__MEMBER__/js/city/jquery.js"></script>
<script type="text/javascript" src="__MEMBER__/js/city/zh-cn/area.js"></script>
<script type="text/javascript" src="__MEMBER__/js/city/zh-cn/location.js"></script>
<script type="text/javascript" src="__MEMBER__/js/city/select2.js"></script>
<script type="text/javascript" src="__MEMBER__/js/city/zh-cn/select2_locale_zh-CN.js"></script>
<script src="__MEMBER__/js/{:L('lng')}/cityselected.js"></script>
<link rel="stylesheet" type="text/css" href="__MEMBER__/css/validationEngine.jquery.css">
<script src="__MEMBER__/js/jquery.validationEngine.js" type='text/javascript'></script>
<script src="__MEMBER__/js/jquery.validationEngine-{:L('lng')}.js" type='text/javascript'></script>
<link href="__MEMBER__/css/select2.css" rel="stylesheet"/>
<script type="text/javascript" src="__MEMBER__/js/jquery.form.js"></script>
<script type="text/javascript" src="__MEMBER__/js/feg_relevance.js"></script>
<script type="text/javascript">
  var select_cr = "{:L('Cr_Select')}"; 
</script>
<script type="text/javascript">
	    $(function(){
	    // validationEngine验证方式
          $('#tempForm').validationEngine('attach', {
            promptPosition: 'topRight',
            scroll: false,
            addPromptClass:'formError-white',
            autoPositionUpdate:true,
            'custom_error_messages':{
            	'#TransferLine':{
            		'required': {
          				'message': "{:L('valEng_Msg_fre')}",
          			}
            	},
            	'#loc_province':{
            		'required':{
            			'message': "{:L('valEng_Msg_fre')}",
            		}
            	},
            	'#loc_city':{
            		'required':{
            			'message': "{:L('valEng_Msg_fre')}",
            		}
            	},
            	'#loc_town':{
            		'required':{
            			'message': "{:L('valEng_Msg_fre')}",
            		}
            	},
            }
          });
        });
</script>
	<div class="form form_index" >
    <form action="" method="POST" id="formorder">
        <input type="hidden" name="" id="savemyid" value="">
    </form>
     <div class="form-signin" style="width:100%;min-height:500px;margin:0 auto;padding:0;">
	    <form action="{:U('Order/saveEdit',array('step'=>$step))}" method="post" class="form-inline" id="tempForm" onsubmit="tempform(this)" enctype="multipart/form-data">
	    	<div class="ordtop">
		    	<!-- **************************************************** -->
	    		<!-- 寄件人信息 -->
		    	<div class="ordsender">
		    		<h4>{:L('SenderInfo')}</h4>
		    		<ul>
		    			<li><label>{:L('FullName')}：</label><input type="text" value="{$info['sender']}" name="PostName" placeholder="{:L('Placeholder_PostName')}" data-validation-engine="validate[required,custom[chinalett]]" maxlength="40"></li>
                        <li>
                            <label>{:L('SenderStreet')}：</label>
                            <input type="text" value="{$info['sendStreet']}" name="PostStreet" placeholder="{:L('Placeholder_PostAddress')}" data-validation-engine="validate[required,custom[repadd]]" maxlength="50"> 
                        </li>
                        <li>
                            <label>{:L('SenderCountry')}：</label>
                            <select class="selcountry" disabled="disabled" >
                                <option selected="selected" value="">U.S.A</option>
                            </select><br>
                            <label>{:L('SenderCity')}：</label>
                            <select id="MainContent_ddProvince">
                                <option value="">{:L('Cr_Select')}</option>
                            </select>
                            <select id="MainContent_ddCity">
                                <option value="">{:L('Cr_Select')}</option>
                            </select><br>
                            <input id="Postcountry" name="PostCountry" value="U.S.A" style="display: none;" />
                            <input id="Postprovince" name="PostState" value="{$info['sendState']}" style="display: none" />
                            <input id="Postcity" name="PostCity" value="{$info['sendCity']}" style="display: none" />
                        </li>
		    			<li><label>{:L('Phone')}：</label><input type="phone" value="{$info['sendTel']}" name="PostPhone" placeholder="{:L('Placeholder_PostPhone')}" data-validation-engine="validate[required,custom[phone]]" maxlength="14"></li>
		    			<li><label>{:L('ZipCode')}：</label><input type="text" value="{$info['sendcode']}" name="PostCode" placeholder="{:L('Placeholder_PostCode')}" data-validation-engine="validate[required,custom[chinaZip]]" maxlength="10"></li>
		    		</ul>
		    	</div>
		    	<!-- **************************************************** -->
	    		<!-- 收件人信息 -->
		    	<div class="ordrec">
		    		<h4>{:L('RecInfo')}</h4>
                    <div class="changebtn">
                        <a href="javascript:;" onclick="infoselect(this)">选择收件人</a>
                    </div>
		    		<ul>
		    			<li><label>{:L('FullName')}：</label><input type="text" value="{$info['receiver']}" data-validation-engine="validate[required,custom[chinalett]]" name="RecName" placeholder="{:L('Placeholder_RecName')}" id="fullName" maxlength="40">
		    			</li>
		    			<li>
		    				<label>{:L('DocumentsType')}：</label>
		    				<select name="Id_tpye" id="Id_tpye">
		    					<volist name="ID_TYPE" id="ty">
		    						<option value="{$key}" <if condition="($info['idkind'] eq $key)">selected</if>>{:L($ty)}</option>
		    					</volist>
		    				</select>
		    				<input type="text" name="IdNo" value="{$info['idno']}" placeholder="{:L('Placeholder_IdNo')}" id="idno" data-validation-engine="validate[required,custom[chinaId]]" style="width:185px !important;" maxlength="18">	    				
		    			</li>
		    			<li style="position: relative;">
		    				<label>{:L('Address')}：</label>
		    				<select id="loc_province" style="width:100px;">
						    </select>
						    <select id="loc_city" style="width:115px; margin-left: 5px">
						    </select>
						    <select id="loc_town" style="width:115px;margin-left: 5px">
						    </select>
						    <input id="province" name="Province" value="{$info['province']}" data-validation-engine="validate[required]"/>
						    <input id="city" name="City" value="{$info['city']}" data-validation-engine="validate[required]"/>
						    <input id="town" name="Town" value="{$info['town']}" data-validation-engine="validate[required]"/>
		    			</li>
		    			<li><label>{:L('DetaileAddress')}：</label><input type="text" value="{$info['reAddr']}" data-validation-engine="validate[required,custom[repadd]]" name="RecAddress" placeholder="{:L('Placeholder_RecAddress')}" id="detaileaddress" maxlength="80"></li>
		    			<li><label>{:L('Phone')}：</label><input type="text" value="{$info['reTel']}" name="RecPhone" data-validation-engine="validate[required,custom[phone]]" placeholder="{:L('Placeholder_RecPhone')}" id="phone" maxlength="14"></li>
		    			<li><label>{:L('ZipCode')}：</label><input type="text" value="{$info['postcode']}" data-validation-engine="validate[required,custom[chinaZip]]" name="RecCode" placeholder="{:L('Placeholder_RecCode')}" id="zipcode" maxlength="10"></li>
		    		</ul>
		    	</div>
		    	<div class="clear"></div>
		    </div>
<!-- **************************************************** -->
	    	<!-- 选择线路 -->
	    	<div class="ordhead"><h3>{:L('SelectLine')}</h3></div>
	    	<div class="ordbody" id="ordbody">
	    		<ul class="lineul" id="lineul">
                    <volist name="tranline" id="vl">
                        <li><input type="radio" name="TransferLine" id="{$vl['id']}" value="{$vl['id']}" class="radio" <if condition="($info['TranKd']) eq $vl['id']">checked onclick="changeline_two(this,0)"<else/>onclick="changeline(this,0)"</if>><label class="radio" for="{$vl['id']}"><php>$l = L('MKLINES');echo $l[$vl['lngname']];</php></label></li>
                    </volist>
                </ul>
                <ul style="display:none;">
                    <volist name="tranline" id="vl">
                        <li class="m{$vl['id']}">
                            <php>
                                $l = L('MKRemarks');echo $l[$vl['lngremark']];
                            </php>
                        </li>
                    </volist>
                </ul>
				<p id="mimenu"></p>
	    	</div>
<!-- **************************************************** -->
            <!-- 异步加载相关线路信息 -->
            <div class="disno" id="disno">
            </div>
            <input type="hidden" name="id" value="{:I('id')}"/>   	
<!-- **************************************************** -->
		</form>
    </div>
   	</div>


<script type="text/javascript">
$(document).ready(function(){
    window.addr_id = 0;
	$(window).bind('beforeunload',function(){
		return '您输入的内容尚未保存，确定离开此页面吗？';
	});
});
</script>
<script type="text/javascript">

	// 这是后台返回的省市区，把它们都分别赋值到那三个select上面显示
	$(function(){	
		var p = "{$info['province']}";
		var c = "{$info['city']}";
        var t = "{$info['town']}";
        var sendstate = "{$info['sendState']}";
        var sendcity = "{$info['sendCity']}";
        $("#select2-chosen-1").html(p);
        $("#select2-chosen-2").html(c);
        $("#select2-chosen-3").html(t);
        // 把选择框的内容发送到后台
        $('#MainContent_ddProvince').change(function(){
            var sit = $(this).children('option:selected').html();
            if(sit==="{:L('Cr_Select')}"){             
              $("#Postprovince").attr("value","");
              $("#PostCity").attr("value","");
            }else{
              $("#Postprovince").attr("value",sit);
            } 
        });
        if(sendstate != ''){
            $("#MainContent_ddProvince").find("option[value='"+sendstate+"']").attr("selected",true).change();
        }else{
            $("#MainContent_ddProvince").children('option:selected').html("{:L('Cr_Select')}");
        }
        $("#MainContent_ddCity").change(function(){
            var sit= $(this).children('option:selected').html();
            if(sit==="{:L('Cr_Select')}"){
              $("#Postprovince").attr("value","");
              $("#Postcity").attr("value","");
            }else{
              $("#Postcity").attr("value",sit);
            }
        });
        if(sendcity != ''){
            $("#MainContent_ddCity").find("option:contains('"+sendcity+"')").attr("selected",true);
            $("#Postcity").attr("value",sendcity);
        }else{
            $("#MainContent_ddCity").children('option:selected').html("{:L('Cr_Select')}"); 
        }
	});
	var order_id = "{:I('id')}";
	var type = "{$type}";
	$(document).ready(function(){
		// 预加载选择线路
		var p2 = $('#lineul').children().find('input:radio[name="TransferLine"]:checked').val();
        $.ajax({
            url:"{:U('Orderlist/console')}",
            dataType:"html",
            data:{"id":p2,"order_id":order_id,"type":type},
            type:"POST",
            cache: false,
            beforeSend:function(){
                var index = layer.load(1, {
                    shade: [0.1,'#000'], //0.1透明度的白色背景
                    offset: '450px',
                });
            },
            success:function(html){
                layer.closeAll('loading'); //关闭加载层
                $('#disno').html(html);

            }
        });		
		if(p2 != ''){
			$("#mimenu").html("{:L('ShowSelect')}："+$(".m"+p2).html());
		}
		// 预加载证件类型
		var chid= $('#Id_tpye').val();
		if(chid == 'PASPORT'){
			$('#idno').attr("placeholder","{:L('Placeholder_IdPT')}");
			$('#idno').attr("maxlength","10");
			$('#idno').attr("data-validation-engine","validate[required]");
		}else if(chid == 'ID'){
			$('#idno').attr("placeholder","{:L('Placeholder_IdNo')}");
			$('#idno').attr("maxlength","18");
			$('#idno').attr("data-validation-engine","validate[required,custom[chinaId]]");
		}
		// 证件类型
		$("#Id_tpye").change(function(){
			var chid= $('#Id_tpye').val();
			if(chid == 'PASPORT'){
				$('#idno').attr("placeholder","{:L('Placeholder_IdPT')}");
				$('#idno').attr("maxlength","10");
				$('#idno').attr("data-validation-engine","validate[required]");
			}else if(chid == 'ID'){
				$('#idno').attr("placeholder","{:L('Placeholder_IdNo')}");
				$('#idno').attr("maxlength","18");
				$('#idno').attr("data-validation-engine","validate[required,custom[chinaId]]");
			}
		});
	});
	// 当编辑继续选择线路调用此函数
    function changeline_two(obj,addr_id){
        var p = $(obj).val();
        if(addr_id==0 && typeof(window.w_id) != "undefined"){
            addr_id = window.w_id;
        }
        $.ajax({
            url:"{:U('Orderlist/console')}",
            dataType:"html",
            data:{"id":p,"order_id":order_id,"type":type,"addr_id":addr_id},
            type:"POST",
            cache: false,
            beforeSend:function(){
                var index = layer.load(1, {
                    shade: [0.1,'#000'], //0.1透明度的白色背景
                    offset: '450px',
                });
            },
            success:function(html){
                layer.closeAll('loading'); //关闭加载层
                $('#disno').html(html);

            }
        });
        if(p != ''){
            var h = $(".m"+p).html();
            $("#mimenu").html("{:L('ShowSelect')}："+h);
        }else{
            $("#mimenu").html('');
        }

    }
	// 选择线路特效
    function changeline(obj,addr_id){
        var p = $(obj).val();
        if(addr_id==0 && typeof(window.w_id) != "undefined"){
            addr_id = window.w_id;
        }
        $.ajax({
            url:"{:U('Orderlist/console')}",
            dataType:"html",
            data:{"id":p,"addr_id":addr_id},
            type:"POST",
            cache: false,
            beforeSend:function(){
                var index = layer.load(1, {
                    shade: [0.1,'#000'], //0.1透明度的白色背景
                    offset: '450px',
                });
            },
            success:function(html){
                layer.closeAll('loading'); //关闭加载层
                $('#disno').html(html);

            }
        });
        if(p != ''){
            var h = $(".m"+p).html();
            $("#mimenu").html("{:L('ShowSelect')}："+h);
        }else{
            $("#mimenu").html('');
        }

    }
    // 通过JQform提交
    function tempform(obj){
        $(window).unbind('beforeunload');
        if(!$("#tempForm").validationEngine("validate")) return ;
        $(obj).ajaxForm({
            dataType: 'json',
            beforeSend:function(){
                var index = layer.load(1, {
                    shade: [0.1,'#000'], //0.1透明度的白色背景
                    offset: '450px',
                });
            },
            success: function(data){
                console.log(data);
                // if(data.state == 'no'){
                //     layer.closeAll('loading'); //关闭加载层
                //     layer.open({
                //         type: 0,
                //         offset: '300px',
                //         shadeClose: true,
                //         title: "{:L('LAY_SystemMessage')}",
                //         content : data.msg,
                //         icon : 5,
                //     });
                //     return false;
                // }else{
                //     layer.alert(data.msg, {icon: 1,offset: '400px'});
                //     layer.closeAll('loading'); //关闭加载层
                //     window.location.href=data.url;
                // }
            },
        });
    }
    // 选择收件人按钮
    function infoselect(obj){
        layer.open({
            type: 2,
            title: "选择收件人",
            area : ['800px' , '500px'],
            offset: '20%',
            closeBtn: 1,
            content: "{:U('Order/selectRecipient')}",
        });
    } 
    function get_addrinfo(addr_id){
        //alert(addr_id);
        $.ajax({
            url:"{:U('order/get_addr_info_ajax')}",
            type:'GET', //GET
            cache: false,    
            data:{
               'addr_id' : addr_id
            },
            dataType:'json',    
            success:function(data){
                console.log(data);
                if(!data.success){
                    layer.msg(data.info, {icon: 5});
                }else{
                    $('#fullName').val(data.info.name);
                    $('#idno').val(data.info.cre_num);
                    $('#detaileaddress').val(data.info.address);
                    $('#phone').val(data.info.tel);
                    $('#zipcode').val(data.info.postal_code);
                    $('#province').val(data.info.province);
                    $('#city').val(data.info.city);
                    $('#town').val(data.info.town);
                    $('#hidaddr_id').val(data.info.id);

                    // 身份证
                    if(data.info.cre_type == 'PASPORT'){
                        $("#Id_tpye").find("option[value='"+data.info.cre_type+"']").attr("selected",true);
                        $('#idno').attr("placeholder","{:L('Placeholder_IdPT')}");
                        $('#idno').attr("maxlength","10");
                        $('#idno').attr("data-validation-engine","validate[required]");
                    }else if(data.info.cre_type == 'ID'){
                        $("#Id_tpye").find("option[value='"+data.info.cre_type+"']").attr("selected",true);
                        $('#idno').attr("placeholder","{:L('Placeholder_IdNo')}");
                        $('#idno').attr("maxlength","18");
                        $('#idno').attr("data-validation-engine","validate[required,custom[chinaId]]");
                    }

                    // 省市区
                    var p = data.info.province;
                    var c = data.info.city;
                    var t = data.info.town;
                    if(p != ''){
                        $("#select2-chosen-1").html(p);
                        $("#province").attr('data-validation-engine','validate[required]');
                        $("#loc_province").removeAttr('data-validation-engine');
                    }else{
                        $("#province").removeAttr('data-validation-engine');
                        $("#loc_province").attr('data-validation-engine','validate[required]');
                    }
                    if(c != ''){
                        $("#select2-chosen-2").html(c);
                        $("#city").attr('data-validation-engine','validate[required]');
                        $("#loc_city").removeAttr('data-validation-engine');
                    }else{
                        $("#city").removeAttr('data-validation-engine');
                        $("#loc_city").attr('data-validation-engine','validate[required]');
                    }
                    if(t != ''){
                        $("#select2-chosen-3").html(t);
                        $("#town").attr('data-validation-engine','validate[required]');
                        $("#loc_town").removeAttr('data-validation-engine');
                    }else{
                        $("#town").removeAttr('data-validation-engine');
                        $("#loc_town").attr('data-validation-engine','validate[required]');        
                    }
                    // alert(data.info.id);

                    // 线路
                    if(data.info.line_id == '0' ){
                        window.w_id = data.info.id;

                        // 修改图片方法
                        var file1 = '<input type="file" name="file_one" id="file" accept="image/jpeg,image/jpg,image/png" atd="1" onclick="fileOnchange(this)" />';
                        var file2 = '<input type="file" name="file_two" id="files" accept="image/jpeg,image/jpg,image/png" atd="2" onclick="fileOnchange(this)" />';
                        $('#obcontid1 input').remove();
                        $('#obcontid2 input').remove();
                        $('#obcontid1 img').after(file1);
                        $('#obcontid2 img').after(file2);

                        $('#fileimage1').attr('src',data.info.id_card_front);
                        $('#fileimage2').attr('src',data.info.id_card_back);
                    }else{

                        $('#lineul li').each(function(k,v){
                            if(data.info.line_id == $(v).children().attr('id')){
                                //alert($(v).children(":checked").val());
                                
                                if($(v).children(":checked").val()!=null){
                                    // 已经选中状态
                                    //alert('123');
                                    window.w_id = data.info.id;

                                    // 修改图片方法
                                    var file1 = '<input type="file" name="file_one" id="file" accept="image/jpeg,image/jpg,image/png" atd="1" onclick="fileOnchange(this)" />';
                                    var file2 = '<input type="file" name="file_two" id="files" accept="image/jpeg,image/jpg,image/png" atd="2" onclick="fileOnchange(this)" />';
                                    $('#obcontid1 input').remove();
                                    $('#obcontid2 input').remove();
                                    $('#obcontid1 img').after(file1);
                                    $('#obcontid2 img').after(file2);

                                    $('#fileimage1').attr('src',data.info.id_card_front);
                                    $('#fileimage2').attr('src',data.info.id_card_back);

                                }else{
                                    // 没有选中状态
                                    // window.addr_id = data.info.id;
                                    //alert('123');
                                    $(v).children().val(data.info.line_id).attr('checked',true);
                                    window.w_id = data.info.id;
                                    $(v).children().click();
                                    // var line = document.getElementById(data.info.line_id);
                                    // changeline(line,data.info.id);

                                }                     
                            }
                        });
                    }
                }
            }
        })
    } 
</script>
<!-- END -->
	<div class="foot"></div>

</block>

</body>
</html>