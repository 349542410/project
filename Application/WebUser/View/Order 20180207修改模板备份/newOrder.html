<!-- 再次下单 -->
<extend name="Member/base" />


<block name="main">
<script type="text/javascript" src="__MEMBER__/js/city/jquery.js"></script>
<script type="text/javascript" src="__MEMBER__/js/city/zh-cn/area.js"></script>
<script type="text/javascript" src="__MEMBER__/js/city/zh-cn/location.js"></script>
<script type="text/javascript" src="__MEMBER__/js/city/select2.js"></script>
<script type="text/javascript" src="__MEMBER__/js/city/zh-cn/select2_locale_zh-CN.js"></script>
<script src="__MEMBER__/js/{:L('lng')}/cityselected.js"></script>
<link rel="stylesheet" type="text/css" href="__MEMBER__/css/validationEngine.jquery.css">
<script src="__MEMBER__/js/jquery.validationEngine.js" type='text/javascript'></script>
<script src="__MEMBER__/js/jquery.validationEngine-{:L('lng')}.js" type='text/javascript'></script>
<link href="__MEMBER__/css/select2.css" rel="stylesheet"/>
<script type="text/javascript" src="__MEMBER__/js/jquery.form.js"></script>
<script type="text/javascript" src="__MEMBER__/js/feg_relevance.js"></script>
<script type="text/javascript">
  var Cr_Select = "{:L('Cr_Select')}";
  var select_cr = "{:L('Cr_Select')}"; 
</script>
<script type="text/javascript">
        $(function(){
          $('#tempForm').validationEngine('attach', {
            promptPosition: 'topRight',
            scroll: false,
            addPromptClass:'formError-white',
            autoPositionUpdate:true,
            'custom_error_messages':{
                '#TransferLine':{
                    'required': {
                        'message': "{:L('valEng_Msg_fre')}",
                    }
                },
                '#loc_province':{
                    'required':{
                        'message': "{:L('valEng_Msg_fre')}",
                    }
                },
                '#loc_city':{
                    'required':{
                        'message': "{:L('valEng_Msg_fre')}",
                    }
                },
                '#loc_town':{
                    'required':{
                        'message': "{:L('valEng_Msg_fre')}",
                    }
                },
            }
          });
        });
</script>
    <div class="form form_index" >
    <div class="form-signin" style="width:100%;min-height:500px;margin:0 auto;padding:0;">
        <form action="{:U('Order/checkForm')}" method="post" class="form-inline" id="tempForm" name="add" enctype="multipart/form-data" onsubmit="tempform(this)">
            <div class="ordtop">
                <!-- **************************************************** -->
                <!-- 寄件人信息 -->
                <div class="ordsender">
                    <h4>{:L('SenderInfo')}</h4>
                    <ul>
                        <li><label>{:L('FullName')}：</label><input type="text" data-validation-engine="validate[required,custom[chinalett]]" value="{$info['sender']}" name="PostName" id="postname" placeholder="{:L('Placeholder_PostName')}" maxlength="40"></li>
                        <li>
                            <label>{:L('SenderStreet')}：</label>
                            <input type="text" value="{$info['sendStreet']}" id="poststreet" name="PostStreet" placeholder="{:L('Placeholder_PostAddress')}" data-validation-engine="validate[required,custom[repadd]]" maxlength="50">
                        </li>
                        <li style="position: relative;">
                            <label>{:L('SenderCountry')}：</label>
                            <select class="selcountry" disabled="disabled" >
                                <option selected="selected" value="">U.S.A</option>
                            </select><br>
                            <label>{:L('SenderCity')}：</label>
                            <select id="MainContent_ddProvince" data-validation-engine="validate[required]">
                                <option selected="selected" value="">{:L('Cr_Select')}</option>
                            </select>
                            <input id="Postcity" name="PostCity" value="{$info['sendCity']}" maxlength="40" style="width: 150px;display: inline-block;border: 1px solid rgb(169,169,169);border-radius: 5px;height: 29px;line-height: 29px;text-indent: 0.5em;position: absolute;bottom: 7px;" />
<!--                             <select id="MainContent_ddCity" data-validation-engine="validate[required]">
                                <option selected="selected" value="">{:L('Cr_Select')}</option>
                            </select><br> -->
                            <input id="Postcountry" name="PostCountry" value="U.S.A" style="display: none;" />
                            <input id="Postprovince" name="PostState" value="{$info['sendState']}" style="display: none" />
<!--                             <input id="Postcity" name="PostCity" value="{$info['sendCity']}" style="display: none" /> -->
                        </li>
                        <li><label>{:L('Phone')}：</label><input type="phone" value="{$info['sendTel']}" name="PostPhone" id="postphone" placeholder="{:L('Placeholder_PostPhone')}" data-validation-engine="validate[required,custom[phone]]" maxlength="14"></li>
                        <li><label>{:L('ZipCode')}：</label><input type="text" value="{$info['sendcode']}" id="postcode" name="PostCode" placeholder="{:L('Placeholder_PostCode')}" data-validation-engine="validate[required,custom[chinaZip]]" maxlength="10"></li>
                    </ul>
                    <button type="button" class="clearSender" onclick="empty_shipper()">{:L('EmptyInfo')}</button>
                </div>
                <!-- **************************************************** -->
                <!-- 收件人信息 -->
                <div class="ordrec">
                    <h4>{:L('RecInfo')}</h4>
                    <ul>
                        <li><label>{:L('FullName')}：</label><input type="text" value="{$info['receiver']}" name="RecName" placeholder="{:L('Placeholder_RecName')}" data-validation-engine="validate[required,custom[chinese]]" maxlength="40">
                        </li>
                        <li>
                            <label>{:L('DocumentsType')}：</label>
                            <select name="Id_tpye" id="Id_tpye">
                                <volist name="ID_TYPE" id="ty">
                                    <option value="{$key}" <if condition="($info['idkind'] eq $key)">selected</if>>{:L($ty)}</option>
                                </volist>
                            </select>
                            <input type="text" name="IdNo" placeholder="{:L('Placeholder_IdNo')}" value="{$info['idno']}" style="width:185px !important;" id="idno" maxlength="18">
                        </li>
                        <li style="position: relative;">
                            <label>{:L('Address')}：</label>
                            <select id="loc_province" style="width:100px;" >
                            </select>
                            <select id="loc_city" style="width:115px;margin-left: 5px" >
                            </select>
                            <select id="loc_town" style="width:115px;margin-left: 5px" >
                            </select>
                            <input <if condition="(L('lng') eq 'zh-cn')"> id="province"</if><if condition="(L('lng') eq 'en-us')"> id="provinces"</if> name="Province" value="{$info['province']}" data-validation-engin="validate[required]" />
                            <input <if condition="(L('lng') eq 'zh-cn')"> id="city"</if><if condition="(L('lng') eq 'en-us')"> id="citys"</if> name="City" value="{$info['city']}" data-validation-engin="validate[required]" />
                            <input <if condition="(L('lng') eq 'zh-cn')"> id="town"</if><if condition="(L('lng') eq 'en-us')"> id="towns"</if> name="Town" value="{$info['town']}" data-validation-engin="validate[required]" />
                            <input type="hidden" name="token" value="{:session('token')}">
                        </li>
                        <li><label>{:L('DetaileAddress')}：</label><input type="text" value="{$info['reAddr']}" name="RecAddress" placeholder="{:L('Placeholder_RecAddress')}" data-validation-engine="validate[required,custom[repadd]]" maxlength="80"></li>
                        <li><label>{:L('Phone')}：</label><input type="text" value="{$info['reTel']}" name="RecPhone" placeholder="{:L('Placeholder_RecPhone')}" data-validation-engine="validate[required,custom[rephone]]" maxlength="14"></li>
                        <li><label>{:L('ZipCode')}：</label><input type="text" value="{$info['postcode']}" name="RecCode" placeholder="{:L('Placeholder_RecCode')}" data-validation-engine="validate[required,custom[chinaZip]]" maxlength="10"></li>
                    </ul>
                </div>
                <div class="clear"></div>
            </div>
<!-- **************************************************** -->
            <!-- 选择线路 -->
            <div class="ordhead"><h3>{:L('SelectLine')}</h3></div>
            <div class="ordbody" id="ordbody">
                <ul  <if condition="(L('lng') eq 'zh-cn')"> id="lineul" class="lineul"</if><if condition="(L('lng') eq 'en-us')">class="lineulus"  id="lineul"</if>>
                    <volist name="tranline" id="vl">
                        <li style="position: relative;"><input type="radio" name="TransferLine" id="{$vl['id']}" value="{$vl['id']}" class="radio" <if condition="($info['TranKd']) eq $vl['id']">checked onclick="changeline_two(this)"<else/>onclick="changeline(this)"</if>><label class="radio" for="{$vl['id']}"><php>$l = L('MKLINES');echo $l[$vl['lngname']];</php></label><span <if condition="(L('lng') eq 'zh-cn')"> style="position: absolute;top: 30px;left: 10px;font-size: 13px;width: 175px;color: #e90000;"<else/>style="position: absolute;top: 0px;right: 175px;font-size: 13px;color: #e90000;"</if> id="line_pice_{$vl['id']}"></span></li>
                    </volist>
                </ul>
                <ul style="display:none;">
                    <volist name="tranline" id="vl">
                        <li class="m{$vl['id']}">
                            <php>
                                $l = L('MKRemarks');echo $l[$vl['lngremark']];
                            </php>
                        </li>
                    </volist>
                </ul>
                <p id="mimenu"></p>
            </div>
<!-- **************************************************** -->
            <!-- 异步加载相关线路信息 -->
            <div class="disno" id="disno">
            </div>              
<!-- **************************************************** -->
        </form>
    </div>
    </div>
<script type="text/javascript">
$(document).ready(function(){
    // $(window).bind('beforeunload',function(){
    //     return '您输入的内容尚未保存，确定离开此页面吗？';
    // });
    // 把选择框的内容发送到后台
    $('#MainContent_ddProvince').change(function(){
        var sit = $(this).children('option:selected').html();
        if(sit==="{:L('Cr_Select')}"){             
          $("#Postprovince").attr("value","");
          $("#PostCity").attr("value","");
        }else{
          $("#Postprovince").attr("value",sit);
        } 
    });
    $("#MainContent_ddCity").change(function(){
        var sit= $(this).children('option:selected').html();
        if(sit==="{:L('Cr_Select')}"){
          $("#Postcity").attr("value","");
        }else{
          $("#Postcity").attr("value",sit);
        }
    });
});
</script>
<script type="text/javascript">
    // 预加载选择线路
    var type = "{$type}";
    var order_id = "{:I('id')}";
    $(document).ready(function(){
        var p2 = $('#lineul').children().find('input:radio[name="TransferLine"]:checked').val();
        $('#ordbody [id^="line_pice"]').text('');
        $.ajax({
            url: "{:U('order/getLinePriceAjax')}",
            dataType:'json',
            type:"POST",
            data:{"line_id":p2},
            success:function(data){
                var info = '';
                if(data.status){
                    info = "{:L('l_first_weight')}"+ parseInt(data.data.weight_first) + 'lb:$'+data.data.fee_first+'；'+"{:L('l_addi_weight')}"+'$'+data.data.fee_next;
                    $('#line_pice_'+p2).text(info);
                }else{

                }
            }
        });
        $.ajax({
            url:"{:U('Orderlist/console')}",
            dataType:"html",
            data:{"id":p2,"order_id":order_id,"type":type},
            type:"POST",
            cache: false,
            beforeSend:function(){
                var index = layer.load(1, {
                    shade: [0.1,'#000'], //0.1透明度的白色背景
                    offset: '450px',
                });
            },
            success:function(html){
                layer.closeAll('loading'); //关闭加载层
                $('#disno').html(html);

            }
        });
        if(p2 != ''){
            $("#mimenu").html("{:L('ShowSelect')}："+$(".m"+p2).html());
        }
        // 预加载证件类型
        var chid= $('#Id_tpye').val();
        if(chid == 'PASPORT'){
            $('#idno').attr("placeholder","{:L('Placeholder_IdPT')}");
            $('#idno').attr("maxlength","10");
            // $('#idno').attr("data-validation-engine","validate[required]");
        }else if(chid == 'ID'){
            $('#idno').attr("placeholder","{:L('Placeholder_IdNo')}");
            $('#idno').attr("maxlength","18");
            // $('#idno').attr("data-validation-engine","validate[required,custom[chinaId]]");
        }       
        // 证件类型
        $("#Id_tpye").change(function(){
            var chid= $('#Id_tpye').val();
            if(chid == 'PASPORT'){
                $('#idno').attr("placeholder","{:L('Placeholder_IdPT')}");
                $('#idno').attr("maxlength","10");
                // $('#idno').attr("data-validation-engine","validate[required]");
            }else if(chid == 'ID'){
                $('#idno').attr("placeholder","{:L('Placeholder_IdNo')}");
                $('#idno').attr("maxlength","18");
                // $('#idno').attr("data-validation-engine","validate[required,custom[chinaId]]");
            }
        });
    });

    // 这是后台返回的省市区，把它们都分别赋值到那三个select上面显示
    $(function(){   
        var p = "{$info['province']}";
        var c = "{$info['city']}";
        var t = "{$info['town']}";
        var sendstate = "{$info['sendState']}";
        var sendcity = "{$info['sendCity']}";
        $("#select2-chosen-1").html(p);
        $("#select2-chosen-2").html(c);
        $("#select2-chosen-3").html(t);
          if(sendstate != ''){
              $("#MainContent_ddProvince").find("option[value='"+sendstate+"']").prop("selected",true).trigger('change');
          }else{
              $("#MainContent_ddProvince").children('option:selected').html(sendstate);
          }
          if(sendcity != ''){
              $("#MainContent_ddCity").find("option:contains('"+sendcity+"')").prop("selected",true);
              $("#Postcity").attr("value",sendcity);
          }else{
              $("#MainContent_ddCity").children('option:selected').html(sendcity); 
          }
    });
    // 当编辑继续选择线路调用此函数
    function changeline_two(obj){
        var p = $(obj).val();
        $('#ordbody [id^="line_pice"]').text('');
        $.ajax({
            url: "{:U('order/getLinePriceAjax')}",
            dataType:'json',
            type:"POST",
            data:{"line_id":p},
            success:function(data){
                var info = '';
                if(data.status){
                    info = "{:L('l_first_weight')}"+ parseInt(data.data.weight_first) + 'lb:$'+data.data.fee_first+'；'+"{:L('l_addi_weight')}"+'$'+data.data.fee_next;
                    $('#line_pice_'+p).text(info);
                }else{

                }
            }
        });
        $.ajax({
            url:"{:U('Orderlist/console')}",
            dataType:"html",
            data:{"id":p,"order_id":order_id,"type":type},
            type:"POST",
            cache: false,
            beforeSend:function(){
                var index = layer.load(1, {
                    shade: [0.1,'#000'], //0.1透明度的白色背景
                    offset: '450px',
                });
            },
            success:function(html){
                layer.closeAll('loading'); //关闭加载层
                $('#disno').html(html);

            }
        });
        if(p != ''){
            var h = $(".m"+p).html();
            $("#mimenu").html("{:L('ShowSelect')}："+h);
        }else{
            $("#mimenu").html('');
        }

    }
    // 选择线路特效
    function changeline(obj){
        var p = $(obj).val();
        $('#ordbody [id^="line_pice"]').text('');
        $.ajax({
            url: "{:U('order/getLinePriceAjax')}",
            dataType:'json',
            type:"POST",
            data:{"line_id":p},
            success:function(data){
                var info = '';
                if(data.status){
                    info = "{:L('l_first_weight')}"+ parseInt(data.data.weight_first) + 'lb:$'+data.data.fee_first+'；'+"{:L('l_addi_weight')}"+'$'+data.data.fee_next;
                    $('#line_pice_'+p).text(info);
                }else{

                }
            }
        });
        $.ajax({
            url:"{:U('Orderlist/console')}",
            dataType:"html",
            data:"id="+p,
            type:"POST",
            cache: false,
            beforeSend:function(){
                var index = layer.load(1, {
                    shade: [0.1,'#000'], //0.1透明度的白色背景
                    offset: '450px',
                });
            },
            success:function(html){
                layer.closeAll('loading'); //关闭加载层
                $('#disno').html(html);

            }
        });
        if(p != ''){
            var h = $(".m"+p).html();
            $("#mimenu").html("{:L('ShowSelect')}："+h);
        }else{
            $("#mimenu").html('');
        }

    }
    // 通过JQform提交
    function tempform(obj){
        $(window).unbind('beforeunload');
        if(!$("#tempForm").validationEngine("validate")) return ;
        $(obj).ajaxForm({
            dataType: 'json',
            beforeSend:function(){
                var index = layer.load(1, {
                    shade: [0.1,'#000'], //0.1透明度的白色背景
                    offset: '450px',
                });
            },
            success: function(data){
                if(data.state == 'no'){
                    var msg;
                    if(!_empty__(data.no)){
                        msg = '<font color="red">['+"{:L('l_the_err')}"+data.no+"{:L('l_line_err')}"+']</font>'+data.msg;
                    }else{
                        msg = data.msg;
                    }
                    layer.closeAll('loading'); //关闭加载层
                    layer.open({
                        type: 0,
                        offset: '300px',
                        shadeClose: true,
                        title: "{:L('LAY_SystemMessage')}",
                        content : msg,
                        icon : 5,
                    });
                    return false;
                }else{
                    layer.closeAll('loading'); //关闭加载层
                    window.location.href=data.url;
                }
            },
        });
    }   
function empty_shipper(){
  $('#postname').val("");
  $('#poststreet').val("");
  $('#postphone').val("");
  $('#postcode').val("");
  $("#MainContent_ddProvince").find("option:contains('"+Cr_Select+"')").prop("selected",true);
  $("#MainContent_ddCity").find("option:contains('"+Cr_Select+"')").prop("selected",true);
}  
window.picro_id = "{$info['id_img_status']}";
if(picro_id == 0){
    picro_id = 1;
}else if(picro_id==100){
    picro_id = 0;
}else{
    picro_id = 2;
}    
</script>
    <div class="foot"></div>

</block>

</body>
</html>