<!-- 在线下单 -->
<extend name="Member/base" />


<block name="main">
<script type="text/javascript" src="__MEMBER__/js/city/jquery.js"></script>
<script type="text/javascript" src="__MEMBER__/js/city/{:L('lng')}/area.js"></script>
<script type="text/javascript" src="__MEMBER__/js/city/{:L('lng')}/location.js"></script>
<script type="text/javascript" src="__MEMBER__/js/city/select2.js"></script>
<script type="text/javascript" src="__MEMBER__/js/city/{:L('lng')}/select2_locale_zh-CN.js"></script>
<script src="__MEMBER__/js/{:L('lng')}/cityselected.js"></script>
<link rel="stylesheet" type="text/css" href="__MEMBER__/css/validationEngine.jquery.css">
<script src="__MEMBER__/js/jquery.validationEngine.js" type='text/javascript'></script>
<script src="__MEMBER__/js/jquery.validationEngine-{:L('lng')}.js" type='text/javascript'></script>
<link href="__MEMBER__/css/select2.css" rel="stylesheet"/>
<script type="text/javascript">
        $(function(){
          $('#tempForm').validationEngine('attach', {
            promptPosition: 'topRight',
            scroll: false,
            addPromptClass:'formError-white',
            autoPositionUpdate:true,
            'custom_error_messages':{
                '#TransferLine':{
                    'required': {
                        'message': "{:L('valEng_Msg_fre')}",
                    }
                },
                '#loc_province':{
                    'required':{
                        'message': "{:L('valEng_Msg_fre')}",
                    }
                },
                '#loc_city':{
                    'required':{
                        'message': "{:L('valEng_Msg_fre')}",
                    }
                },
                '#loc_town':{
                    'required':{
                        'message': "{:L('valEng_Msg_fre')}",
                    }
                },
            }
          });
        });
</script>

    <div class="form form_index" >
    <div class="form-signin" style="width:100%;min-height:500px;margin:0 auto;padding:0;">
        <form action="{:U('Order/step_two')}" method="POST" class="form-inline" id="tempForm" name="add">
            <div class="ordtop">
                <!-- **************************************************** -->
                <!-- 寄件人信息 -->
                <div class="ordsender">
                    <h4>{:L('SenderInfo')}</h4>
                    <ul>
                        <li><label>{:L('FullName')}：</label><input type="text" value="{$info['PostName']|default=''}" name="PostName" placeholder="{:L('Placeholder_PostName')}" data-validation-engine="validate[required,custom[chinalett]]" maxlength="40"></li>
                        <li><label>{:L('DetaileAddress')}：</label><input type="text" value="{$info['PostAddress']|default=''}" name="PostAddress" placeholder="{:L('Placeholder_PostAddress')}" data-validation-engine="validate[required,custom[repadd]]" maxlength="80"></li>
                        <li><label>{:L('Phone')}：</label><input type="phone" value="{$info['PostPhone']|default=''}" name="PostPhone" placeholder="{:L('Placeholder_PostPhone')}" data-validation-engine="validate[required,custom[phone]]" maxlength="14"></li>
                        <li><label>{:L('ZipCode')}：</label><input type="text" value="{$info['PostCode']|default=''}" name="PostCode" placeholder="{:L('Placeholder_PostCode')}" data-validation-engine="validate[required,custom[chinaZip]]" maxlength="10"></li>
                    </ul>
                    <button type="button" class="clearSender" onclick="javascript:$('.ordsender input').val('');">{:L('EmptyInfo')}</button>
                </div>
                <!-- **************************************************** -->
                <!-- 收件人信息 -->
                <div class="ordrec">
                    <h4>{:L('RecInfo')}</h4>
                    <ul>
                        <li><label>{:L('FullName')}：</label><input type="text" value="" data-validation-engine="validate[required,custom[chinalett]]" name="RecName" placeholder="{:L('Placeholder_RecName')}"  maxlength="40">
                        </li>
                        <li>
                            <label>{:L('DocumentsType')}：</label>
                            <select name="Id_tpye" id="Id_tpye">
                                <volist name="ID_TYPE" id="ty">
                                    <option value="{$key}">{:L($ty)}</option>
                                </volist>
                            </select>
                            <input type="text" name="IdNo" placeholder="{:L('Placeholder_IdNo')}" id="idno" data-validation-engine="validate[required,custom[chinaId]]" style="width:235px !important;" maxlength="18">
                        </li>
                        <li style="position: relative;">
                            <label>{:L('Address')}：</label>
                            <select id="loc_province" style="width:100px;" data-validation-engine="validate[required]">
                            </select>
                            <select id="loc_city" style="width:115px; margin-left: 5px" data-validation-engine="validate[required]">
                            </select>
                            <select id="loc_town" style="width:115px;margin-left: 5px" data-validation-engine="validate[required]">
                            </select>
                            <input id="province" name="Province" value="" style="display: none" />
                            <input id="city" name="City" value="" style="display: none" />
                            <input id="town" name="Town" value="" style="display: none" />
                            <input type="hidden" name="token" value="{:session('token')}">
                        </li>
                        <li><label>{:L('DetaileAddress')}：</label><input type="text" value="" data-validation-engine="validate[required,custom[repadd]]"  name="RecAddress" placeholder="{:L('Placeholder_RecAddress')}" maxlength="80"></li>
                        <li><label>{:L('Phone')}：</label><input type="text" value="" data-validation-engine="validate[required,custom[phone]]" name="RecPhone" placeholder="{:L('Placeholder_RecPhone')}"  maxlength="14"></li>
                        <li><label>{:L('ZipCode')}：</label><input type="text" value="" data-validation-engine="validate[required,custom[chinaZip]]" name="RecCode" placeholder="{:L('Placeholder_RecCode')}"  maxlength="10"></li>
                    </ul>
                </div>
            </div>
<!-- **************************************************** -->
            <!-- 选择线路 -->
            <div class="ordhead"><h3>{:L('SelectLine')}</h3></div>
            <div class="ordbody">
                <table class="tab1" border="0" cellpadding="0" cellspacing="0">
                    <tr>
                        <td class="tdleft"><label>{:L('TranLine')}：</label></td>
                        <td style="width: 90px;">
                        <label>
                        <select name="TransferLine" id="TransferLine" class="form-control" data-validation-engine="validate[required]">
                            <option value="">{:L('PleaseSelectLine')}</option>
                            <volist name="tranline" id="vo">
                                <option value="{$vo['id']}" ><php>$l = L('MKLINES');echo $l[$vo['lngname']];</php></option>
                            </volist>
        <!--                    <option value="1" <if condition="($info['TranKd']) eq '1'">selected</if>><php>$l = L('MKLINES');echo $l[1];</php></option>
                            <option value="2" <if condition="($info['TranKd']) eq '2'">selected</if>><php>$l = L('MKLINES');echo $l[2];</php></option> -->
                        </select>
                        </label>
                        </td>
                        <ul style="display:none;">
                            <volist name="tranline" id="vo">
                                <li class="m{$vo['id']}"><php>$l = L('MKRemarks');echo $l[$vo['lngremark']];</php></li>
                            </volist>
                        </ul>
                    </tr>
                </table>
                <p id="mimenu"></p>
            </div>
<!-- **************************************************** -->
            <!-- 货品声明 -->
            <div class="ordhead"><h3>{:L('GoodsList')}</h3></div>
            <div class="ordbody oblast">
                    <table class="table_now" style="margin:10px auto;height:110px;margin-left: -106px;" id="table">
                    <input type="hidden" id="num" value="5" autocomplete="off">
                        <tr>
                            <td width="10%" style="font-weight: bold;" class="copy_r"></td>
                            <td width="10%" style="font-weight: bold;">{:L('BrandName')}</td>
                            <td width="10%" style="font-weight: bold;">{:L('ProductName')}</td>
                            <td width="10%" style="font-weight: bold;">{:L('ProCate')}</td>
                            <td width="20%" style="font-weight: bold;">{:L('Customs')}</td>
                            <td width="10%" style="font-weight: bold;display: none" class="chuijin">{:L('Tax')}（$）</td>
                            <td width="10%" style="font-weight: bold;">{:L('Amount')}</td>
                            <td width="10%" style="font-weight: bold;">{:L('UnitPrice')}</td>
                            <td width="10%" style="font-weight: bold;">{:L('Currency')}</td>
                            <td width="10%" style="font-weight: bold;">{:L('Remarks')}</td>
                        </tr>
                        <!-- 配置控制行数 gan -->
                        <for start="1" end="$Think.config.OROW" name="j"> 
                        <tr>
                            <td class="copy_r"><if condition="$j eq 1"><a onclick="copy_row(this)" href="javascript:void(0)">[+]</a></if></td>
                            <td width="10%;"><input type="text" name="brand_{$j}" class="clchang" maxlength="50"></td>
                            <td width="10%;"><input type="text" name="product_{$j}" class="clchang" maxlength="50"></td>
                            
                            <td width="10%;"><input type="text" name="catname_{$j}" class="clchang" maxlength="10"></td>

                            <td width="20%;" class="gnone">---</td>
                            <td width="30%;" class="gtree" style="display: none">
                                <select name="category_one_{$j}" onchange="selecchang(this)">
                                    <option>{:L('Cr_Select')}</option>
                                    <volist name="cat_list" id="vvo">
                                        <option value="{$vvo['id']}">{$vvo['cat_name']}</option>
                                    </volist>
                                </select>
                                <select name="category_two_{$j}" onchange="selectc(this)">
                                    <option value="">{:L('Cr_Select')}</option>
                                </select>   
                            </td>
                            <td width="10%;" style="display: none" class="chuijin"><label>0.00</label></td>
                            <td width="10%;" class="amount"><input type="text" name="amount_{$j}" class="clzhong" maxlength="9"></td>

                            <td width="10%;"><input type="text" name="price_{$j}" class="clzhong" maxlength="9"></td>
                            <!-- 币种 -->
                            <td width="10%;" class="clzhong">
                                <select name="coin_{$j}" id="" class="clduan">
                                    <!-- <option value=""></option> -->
                                    <option value="CNY" selected="selected">￥</option>
                                    <!-- <option value="USD">$</option> -->
                                </select>
                            </td>
                            <td width="10%;" ><input type="text" name="remark_{$j}" class="clchang"></td>
                        </tr>
                        </for>
                    </table>
                    <span class="forspan">{:L('Notice')}</span>
            </tr>
            
<!-- **************************************************** -->
            <!-- 按钮部分 -->
            <tr>
                <table style="width: 1000px;float: right;margin: 0 auto;">
                    <tr>
                        <td id="hide_boxs">
                            <input type="hidden" value="{$user_id}" name="uid">
                        </td>
                        <td style="text-align: right;">
                            <span id="loading" style="bottom:180px;left:650px !important;"></span>
                            <button type="submit" class="btn" id="BtnSave" onclick="submitform(this)">{:L('BtnSave')}</button>
                            <!-- <button type="button" class="btn btn-default" data-dismiss="modal" id="beClosed">关闭</button> -->
                            <span id="messagebox" class="msgbox" style="bottom:180px;left:650px !important"></span>                 
                        </td>
                    </tr>
                </table>
            </tr>
            </table>
            </div>
<!-- END -->
            <div style="clear:both;"></div>
        </form>
    </div>
    </div>
<script type="text/javascript">
$(document).ready(function(){
    $(window).bind('beforeunload',function(){
        return '您输入的内容尚未保存，确定离开此页面吗？';
    });
});
</script>
<script type="text/javascript">
    // 选择线路特效
    $(document).ready(function(){
        $('#TransferLine').change(function(){
            var p = $(this).children('option:selected').val();//这就是selected的值
            if(p == 5){
                $('.gtree').css("display","table-cell");
                $('.gnone').css("display",'none');
                $('.chuijin').css("display","table-cell");
                $('#table').css("margin-left","-64px");
            }else{
                $('.gtree').css("display","none");
                $('.gnone').css("display",'table-cell');
                $('.chuijin').css("display","none");
                $('#table').css("margin-left","-106px");
            }
            if(p != ''){
                var h = $(".m"+p).html();
                $("#mimenu").html("{:L('ShowSelect')}："+h);
            }else{
                $("#mimenu").html('');
            }
        });
        var chid= $('#Id_tpye').val();
        if(chid == 'PASPORT'){
            $('#idno').attr("placeholder","{:L('Placeholder_IdPT')}");
            $('#idno').attr("maxlength","10");
            $('#idno').attr("data-validation-engine","validate[required]");
        }else if(chid == 'ID'){
            $('#idno').attr("placeholder","{:L('Placeholder_IdNo')}");
            $('#idno').attr("maxlength","18");
            $('#idno').attr("data-validation-engine","validate[required,custom[chinaId]]");
        }       
        // 证件类型
        $("#Id_tpye").change(function(){
            var chid= $('#Id_tpye').val();
            if(chid == 'PASPORT'){
                $('#idno').attr("placeholder","{:L('Placeholder_IdPT')}");
                $('#idno').attr("maxlength","10");
                $('#idno').attr("data-validation-engine","validate[required]");
            }else if(chid == 'ID'){
                $('#idno').attr("placeholder","{:L('Placeholder_IdNo')}");
                $('#idno').attr("maxlength","18");
                $('#idno').attr("data-validation-engine","validate[required,custom[chinaId]]");
            }
        });
    });
    function submitform(obj){
        $(window).unbind('beforeunload');
        if(!$("#tempForm").validationEngine("validate")) return ;
        $.ajax({
            cache: false,
            type: "POST",
            url:"{:U('Order/checkForm')}",
            data:$('#tempForm').serialize(),// 你的formid
            async: false,
            beforeSend:function(){
                $("#loading").html('<img style="width:28px;height:28px;" src="__MEMBER__/images/msg_loading_d.gif"/>');
            },
            error: function(request) {
                layer.alert("{:L('LAY_ErrorForm')}");
            },
            success: function(data) {
                if(data.state == 'no'){
                    layer.open({
                        type: 0,
                        offset: '300px',
                        shadeClose: true,
                        title: "{:L('LAY_SystemMessage')}",
                        content : data.msg,
                        icon : 5,
                    });
                    $("#loading").html('');
                    $("#BtnSave").attr("type","button");  
                }else{
                    var box_part='<input type="hidden" value="'+data.uucode+'" name="uucode"><input type="hidden" value="'+data.sn+'" name="sn"><input type="hidden" value="'+data.lid+'" name="lid">';
                    $("#hide_boxs").append(box_part);
                    $("#BtnSave").attr("disabled","true"); //设置变灰按钮  
                    $('#tempForm').submit();
                    setTimeout("$('#BtnSave').removeAttr('disabled');",3000); //设置三秒后提交按钮 显示 
                }
            }
        });
    }

    // 添加删除行 20170316 gan
    function copy_row(obj)
    {
        var num=$("#num").val();
        num++;
        if(num>=10){
            layer.open({
                title:"{:L('LAY_SystemMessage')}",
                offset: '300px',
                icon : 0,
                content: "{:L('LAY_AddRow')}",
            });
            $('.copy_r').find('a').remove();
        }
        var sele = "{:L('Cr_Select')}";
        var Tline = $('#TransferLine').children('option:selected').val();
        var str='<tr><td class="copy_r"><if condition="$j eq 5"><a onclick="copy_row(this)" href="javascript:void(0)">[+]</a></if></td><td width="10%;"><input type="text" class="clchang" name="brand_'+num+'"></td><td width="10%;"><input type="text" class="clchang" name="product_'+num+'"></td><td width="10%;"><input type="text" class="clchang" name="catname_'+num+'"></td><td width="20%;" class="gnone">---</td><td width="30%;" class="gtree" style="display: none"><select name="category_one_'+num+'" onchange="selecchang(this)"><option>'+sele+'</option><volist name="cat_list" id="vvo"><option value="{$vvo['id']}">{$vvo['cat_name']}</option></volist></select><select name="category_two_'+num+'" onchange="selectc(this)"><option value="">'+sele+'</option></select></td><td width="10%;" style="display: none" class="chuijin"><label>0.00</label></td><td width="10%;" class="amount"><input type="text" class="clzhong" name="amount_'+num+'"></td><td width="10%;"><input type="text" class="clzhong" name="price_'+num+'"></td><td width="10%;"><select class="clduan" name="coin_'+num+'" id=""><option value="CNY" selected="selected">￥</option></select></td><td width="10%;" ><input type="text" class="clchang" name="remark_'+num+'"></td></tr>';

        var tlstr = '<tr><td class="copy_r"><if condition="$j eq 5"><a onclick="copy_row(this)" href="javascript:void(0)">[+]</a></if></td><td width="10%;"><input type="text" class="clchang" name="brand_'+num+'"></td><td width="10%;"><input type="text" class="clchang" name="product_'+num+'"></td><td width="10%;"><input type="text" class="clchang" name="catname_'+num+'"><td width="20%;" class="gnone" style="display:none">---</td></td><td width="30%;" class="gtree" style="display: table-cell"><select name="category_one_'+num+'" onchange="selecchang(this)"><option>'+sele+'</option><volist name="cat_list" id="vvo"><option value="{$vvo['id']}">{$vvo['cat_name']}</option></volist></select><select name="category_two_'+num+'" onchange="selectc(this)"><option value="">'+sele+'</option></select></td><td width="10%;" style="display: table-cell" class="chuijin"><label>0.00</label></td><td width="10%;" class="amount"><input type="text" class="clzhong" name="amount_'+num+'"></td><td width="10%;"><input type="text" class="clzhong" name="price_'+num+'"></td><td width="10%;"><select class="clduan" name="coin_'+num+'" id=""><option value="CNY" selected="selected">￥</option></select></td><td width="10%;" ><input type="text" class="clchang" name="remark_'+num+'"></td></tr>';
        if(Tline != 5){
            $("#table").append(str);  
        }else{
           $("#table").append(tlstr);   
        }
        //console.log(str);

        $("#num").val(num);
    }
    function selecchang(obj){
        var no = obj.value;
        //var tt = $(obj).parent('td');
        //alert(tt);
        $.ajax({
            type: "GET",
            url: "{:U('Order/next_level')}",
            data: "id="+no,
            success:function(data){
                $(obj).next('select').find('option').remove();
                $(obj).next('select').append("<option value=''>{:L('Cr_Select')}</option>");
                $.each(data, function (i, item) {  
                    $(obj).next('select').append("<option value=" + item.id + " price="+ item.price +">" + item.cat_name + "</option>");//赋值
                }); 
            }
        });
    } 
    function selectc(obj){
        var aminp = $(obj).parent('td').siblings('.amount').find('input');
        var sui = $(obj).parent('td').siblings('.chuijin').find('label');
        var gg = $(obj).find("option:selected").attr("price");
        var aminp = $(obj).parent('td').siblings('.amount').find('input');
        var aipv = $(aminp).val();                  
        if(aipv != ''){
            var conts = (aipv*gg).toFixed(2);
            $(sui).html(conts);
        }else{
            $(sui).html(gg);
        }                   
        $(aminp).blur(function(){
            var inpn = $(this).val();
            //alert(sui);
            var cont = (inpn*gg).toFixed(2);
            $(obj).parent('td').siblings('.chuijin').find('label').html(cont);
        });

    }
</script>
<!-- END -->
    <div class="foot"></div>

</block>

</body>
</html>