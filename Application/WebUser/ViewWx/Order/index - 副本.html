<!-- 在线下单 -->
<extend name="Member/base" />


<block name="main">
<script type="text/javascript" src="__APPWX__/js/city/jquery.js"></script>
<script type="text/javascript" src="__APPWX__/js/city/area.js"></script>
<script type="text/javascript" src="__APPWX__/js/city/location.js"></script>
<script type="text/javascript" src="__APPWX__/js/city/select2.js"></script>
<script type="text/javascript" src="__APPWX__/js/city/select2_locale_zh-CN.js"></script>
<script src="__APPWX__/js/cityselected.js"></script>
<link rel="stylesheet" type="text/css" href="__APPWX__/css/order.css">
<link rel="stylesheet" type="text/css" href="__MEMBER__/css/validationEngine.jquery.css">
<script src="__MEMBER__/js/jquery.validationEngine.js" type='text/javascript'></script>
<script src="__MEMBER__/js/jquery.validationEngine-{:L('lng')}.js" type='text/javascript'></script>
<script type="text/javascript" src="__MEMBER__/js/jquery.form.js"></script>
<script type="text/javascript" src="__MEMBER__/js/feg_relevance.js"></script>
<link href="__MEMBER__/css/select2.css" rel="stylesheet"/>
<script type="text/javascript">
    var Cr_Select = "{:L('Cr_Select')}";
    var select_cr = "{:L('Cr_Select')}"; 
</script>
<script type="text/javascript">
        $(function(){
          $('#tempForm').validationEngine('attach', {
            promptPosition: 'topRight',
            scroll: false,
            addPromptClass:'formError-white',
            autoPositionUpdate:true,
            'custom_error_messages':{
                '#TransferLine':{
                    'required': {
                        'message': "{:L('valEng_Msg_fre')}",
                    }
                },
                '#loc_province':{
                    'required':{
                        'message': "{:L('valEng_Msg_fre')}",
                    }
                },
                '#loc_city':{
                    'required':{
                        'message': "{:L('valEng_Msg_fre')}",
                    }
                },
                '#loc_town':{
                    'required':{
                        'message': "{:L('valEng_Msg_fre')}",
                    }
                },
            }
          });
        });
</script>

	<div class="form form_index" >
	    <div class="form-signin" style="width:100%;margin:0 auto;padding:0;">
		    <form action="{:U('Order/checkForm')}" method="POST" class="form-inline" id="tempForm" name="add" enctype="multipart/form-data" onsubmit="tempform(this)">
			    <div class="ordtop row">
			    	<!-- **************************************************** -->
		    		<!-- 寄件人信息 -->
			    	<div class="ordsender col-xs-12 col-sm-6">
			    		<h4>{:L('SenderInfo')}</h4>
				    	<div class="changebtn">
	                        <a href="javascript:;" onclick="addsern(this)">{:L('l_select_sender')}</a>
	                    </div>
			    	<ul>
		    			<li><label>{:L('FullName')}：</label><input type="text" value="{$info['PostName']|default=''}" id="postname" name="PostName" placeholder="{:L('Placeholder_PostName')}" data-validation-engine="validate[required,custom[chinalett]]" maxlength="40"></li>
		    			<li><label>{:L('SenderStreet')}：</label><input type="text" value="{$info['PostStreet']|default=''}" id="poststreet" name="PostStreet" placeholder="{:L('Placeholder_PostAddress')}" data-validation-engine="validate[required,custom[repadd]]" maxlength="50"></li>
                        <li>
                            <label>{:L('SenderCountry')}：</label>
                            <select class="selcountry" disabled="disabled" >
                                <option selected="selected" value="">U.S.A</option>
                            </select><br>
                            <label>{:L('SenderCity')}：</label>
                            <select id="MainContent_ddProvince">
                                <option value="">{:L('Cr_Select')}</option>
                            </select>
                            <select id="MainContent_ddCity">
                                <option value="">{:L('Cr_Select')}</option>
                            </select><br>
                            <input id="Postcountry" name="PostCountry" value="U.S.A" style="display: none;" />
                            <input id="Postprovince" name="PostState" value="{$info['California']|default=''}" style="display: none" />
                            <input id="Postcity" name="PostCity" value="{$info['Fremont']|default=''}" style="display: none" />
                        </li>
		    			<li><label>{:L('Phone')}：</label><input type="phone" value="{$info['PostPhone']|default=''}" id="postphone" name="PostPhone" placeholder="{:L('Placeholder_PostPhone')}" data-validation-engine="validate[required,custom[phone]]"></li>
		    			<li><label>{:L('ZipCode')}：</label><input type="text" value="{$info['PostCode']|default=''}" id="postcode" name="PostCode" placeholder="{:L('Placeholder_PostCode')}" data-validation-engine="validate[required,custom[chinaZip]]" maxlength="10"></li>
		    		</ul>
			    		<button type="button" class="clearSender" onclick="javascript:$('.ordsender input').val('');">{:L('EmptyInfo')}</button>
			    	</div>
			    	<!-- **************************************************** -->
		    		<!-- 收件人信息 -->
			    	<div class="ordrec col-xs-12 col-sm-6">
                    <input type="hidden" name="addr_id" value="" id="hidaddr_id">
			    		<h4>{:L('RecInfo')}</h4>
				    	<div class="changebtn">
		                    <a href="javascript:;" onclick="infoselect(this)">{:L('l_cho_rec')}</a>
		                </div>
			    		<ul>
		    			<li><label>{:L('FullName')}：</label><input type="text" value="" id="fullname" name="RecName" placeholder="{:L('Placeholder_RecName')}" data-validation-engine="validate[required,custom[chinalett]]" maxlength="40">
		    			</li>
		    			<li class="addres">
		    				<label>{:L('DocumentsType')}：</label>
		    				<select name="Id_tpye" id="Id_tpye">
		    					<volist name="ID_TYPE" id="ty">
		    						<option value="{$key}">{:L($ty)}</option>
		    					</volist>
		    				</select>
		    				<input type="text" name="IdNo" placeholder="{:L('Placeholder_IdNo')}" id="idno" data-validation-engine="validate[required,custom[chinaId]]" style="width:185px !important;" maxlength="18">
		    			</li>
		    			<li class="addres">
		    				<label>{:L('Address')}：</label>
		    				<select id="loc_province" style="width:100px;" data-validation-engine="validate[required]">
						    </select>
						    <select id="loc_city" style="width:115px; margin-left: 5px" data-validation-engine="validate[required]">
						    </select>
						    <select id="loc_town" style="width:115px;margin-left: 45px" data-validation-engine="validate[required]">
						    </select>
						    <input id="province" name="Province" value="" style="display:none" />
						    <input id="city" name="City" value="" style="display:none" />
						    <input id="town" name="Town" value="" style="display:none" />
						    <input type="hidden" name="token" value="{:session('token')}">
		    			</li>
		    			<li><label>{:L('DetaileAddress')}：</label><input type="text" value="" id="detaileaddress" name="RecAddress" placeholder="{:L('Placeholder_RecAddress')}" data-validation-engine="validate[required,custom[repadd]]"></li>
		    			<li><label>{:L('Phone')}：</label><input type="text" value="" id="phone" name="RecPhone" placeholder="{:L('Placeholder_RecPhone')}" data-validation-engine="validate[required,custom[phone]]"></li>
		    			<li><label>{:L('ZipCode')}：</label><input type="text" value="" id="zipcode" name="RecCode" placeholder="{:L('Placeholder_RecCode')}" data-validation-engine="validate[required,custom[chinaZip]]" maxlength="10"></li>
		    		</ul>
			    	</div>
			    </div>
	<!-- **************************************************** -->
		    	<!-- 选择线路 -->
		    	<div class="ordhead"><h3>{:L('SelectLine')}</h3></div>
		    	<div class="ordbody">
			    	<table class="tab1" border="0" cellpadding="0" cellspacing="0">
					    <tr>
							<td class="tdleft"><label>{:L('TranLine')}：</label></td>
							<td>
							<label>
			                <select name="TransferLine" id="TransferLine" class="form-control" data-validation-engine="validate[required]">
								<option value="">{:L('PleaseSelectLine')}</option>
								<volist name="tranline" id="vo">
									<option value="{$vo['id']}" ><php>$l = L('MKLINES');echo $l[$vo['lngname']];</php></option>
								</volist>
			<!-- 					<option value="1" <if condition="($info['TranKd']) eq '1'">selected</if>><php>$l = L('MKLINES');echo $l[1];</php></option>
								<option value="2" <if condition="($info['TranKd']) eq '2'">selected</if>><php>$l = L('MKLINES');echo $l[2];</php></option> -->
			                </select>
							</label>
							</td>

			            </tr>
						<table><p id="mimenu"></p></table>
							<ul style="display:none;">
								<volist name="tranline" id="vo">
									<li class="m{$vo['id']}"><php>$l = L('MKRemarks');echo $l[$vo['lngremark']];</php></li>
								</volist>
							</ul>
					</table>
		    	</div>
	<!-- **************************************************** -->
            <!-- 异步加载相关线路信息 -->
            <div class="disno" id="disno">
            </div>
	<!-- **************************************************** -->
			</form>
	    </div>
   	</div>
<script type="text/javascript">
	// 选择线路特效
	$(document).ready(function(){
		window.addr_id = 0;
		$('#TransferLine').change(function(){
				var p = $(this).children('option:selected').val();//这就是selected的值
			    if(addr_id==0 && typeof(window.w_id) != "undefined"){
			        addr_id = window.w_id;
			    }
			    $.ajax({
	                url:"{:U('Orderlist/console')}",
	                dataType:"html",
	                data:{"id":p,"addr_id":addr_id},
	                type:"POST",
	                cache: false,
	                beforeSend:function(){
	                    var index = layer.load(1, {
	                        shade: [0.1,'#000'], //0.1透明度的白色背景
	                        offset: '450px',
	                    });
	                },
	                success:function(html){
	                    layer.closeAll('loading'); //关闭加载层
	                    $('#disno').html(html);

	                }
	            });
			if(p != ''){
				var h = $(".m"+p).html();
				$("#mimenu").html('说明：'+h);
			}else{
				$("#mimenu").html('');
			}
		});
		var chid= $('#Id_tpye').val();
        if(chid == 'PASPORT'){
            $('#idno').attr("placeholder","{:L('Placeholder_IdPT')}");
            $('#idno').attr("maxlength","10");
            $('#idno').attr("data-validation-engine","validate[required]");
        }else if(chid == 'ID'){
            $('#idno').attr("placeholder","{:L('Placeholder_IdNo')}");
            $('#idno').attr("maxlength","18");
            $('#idno').attr("data-validation-engine","validate[required,custom[chinaId]]");
        }  
        // 证件类型
        $("#Id_tpye").change(function(){
            var chid= $('#Id_tpye').val();
            if(chid == 'PASPORT'){
                $('#idno').attr("placeholder","{:L('Placeholder_IdPT')}");
                $('#idno').attr("maxlength","10");
                $('#idno').attr("data-validation-engine","validate[required]");
            }else if(chid == 'ID'){
                $('#idno').attr("placeholder","{:L('Placeholder_IdNo')}");
                $('#idno').attr("maxlength","18");
                $('#idno').attr("data-validation-engine","validate[required,custom[chinaId]]");
            }
        });
	});


	function tempform(obj){
        $(window).unbind('beforeunload');
        if(!$("#tempForm").validationEngine("validate")) return ;
        $(obj).ajaxForm({
            dataType: 'json',
            beforeSend:function(){
                var index = layer.load(1, {
                    shade: [0.1,'#000'], //0.1透明度的白色背景
                    offset: '450px',
                });
            },
            success: function(data){
                if(data.state == 'no'){
                    layer.closeAll('loading'); //关闭加载层
                    layer.open({
                        type: 0,
                        offset: '300px',
                        shadeClose: true,
                        title: "{:L('LAY_SystemMessage')}",
                        content : data.msg,
                        icon : 5,
                    });
                    return false;
                }else{
                    layer.closeAll('loading'); //关闭加载层
                    window.location.href=data.url;
                }
            },
        });
    }

//选择收件人按钮
function infoselect(obj){
    layer.open({
        type: 2,
        title: "{:L('l_cho_rec')}",
        area : ['90%' , '80%'],
        offset: '5%',
        closeBtn: 1,
        content: "{:U('Order/selectRecipient')}",
    });
}
// 选择收件人数据
function get_addrinfo(addr_id){
    //alert(addr_id);
    $.ajax({
        url: "{:U('order/get_addr_info_ajax')}",
        type:'GET', //GET
        cache: false,    
        data:{
           'addr_id' : addr_id
        },
        dataType:'json',    
        success:function(data){
            // console.log(data);
            if(!data.success){
                layer.msg(data.info, {icon: 5});
            }else{
                $('#tempForm').validationEngine('hideAll');                    
                $('#fullname').val(data.info.name);
                $('#idno').val(data.info.cre_num);
                $('#detaileaddress').val(data.info.address);
                $('#phone').val(data.info.tel);
                $('#zipcode').val(data.info.postal_code);
                $('#province').val(data.info.province);
                $('#city').val(data.info.city);
                $('#town').val(data.info.town);
                $('#hidaddr_id').val(data.info.id);

                // 身份证
                if(data.info.cre_type == 'PASPORT'){
                    $("#Id_tpye").find("option[value='"+data.info.cre_type+"']").attr("selected",true);
                    $('#idno').attr("placeholder","{:L('Placeholder_IdPT')}");
                    $('#idno').attr("maxlength","10");
                    $('#idno').attr("data-validation-engine","validate[required]");
                }else if(data.info.cre_type == 'ID'){
                    $("#Id_tpye").find("option[value='"+data.info.cre_type+"']").attr("selected",true);
                    $('#idno').attr("placeholder","{:L('Placeholder_IdNo')}");
                    $('#idno').attr("maxlength","18");
                    $('#idno').attr("data-validation-engine","validate[required,custom[chinaId]]");
                }

                // 省市区
                var datap = data.info.province;
                var datac = data.info.city;
                var datat = data.info.town;
                if(datap != ''){
                    $("#select2-chosen-1").html(datap);
                    $("#province").attr('data-validation-engine','validate[required]');
                    $("#loc_province").removeAttr('data-validation-engine');
                }else{
                    $("#province").removeAttr('data-validation-engine');
                    $("#loc_province").attr('data-validation-engine','validate[required]');
                }
                if(datac != ''){
                    $("#select2-chosen-2").html(datac);
                    $("#city").attr('data-validation-engine','validate[required]');
                    $("#loc_city").removeAttr('data-validation-engine');
                }else{
                    $("#city").removeAttr('data-validation-engine');
                    $("#loc_city").attr('data-validation-engine','validate[required]');
                }
                if(datat != ''){
                    $("#select2-chosen-3").html(datat);
                    $("#town").attr('data-validation-engine','validate[required]');
                    $("#loc_town").removeAttr('data-validation-engine');
                }else{
                    $("#town").removeAttr('data-validation-engine');
                    $("#loc_town").attr('data-validation-engine','validate[required]');        
                }
                // alert(data.info.line_id);

                // 线路

                if(data.info.line_id == '0' ){
                    window.w_id = data.info.id;

                    // 修改图片方法
                    var file1 = '<input type="file" name="file_one" id="file" accept="image/jpeg,image/jpg,image/png" atd="1" onclick="fileOnchange(this)" />';
                    var file2 = '<input type="file" name="file_two" id="files" accept="image/jpeg,image/jpg,image/png" atd="2" onclick="fileOnchange(this)" />';
                    $('#obcontid1 input').remove();
                    $('#obcontid2 input').remove();
                    $('#obcontid1 img').after(file1);
                    $('#obcontid2 img').after(file2);

                    $('#fileimage1').attr('src',data.info.id_card_front);
                    $('#fileimage2').attr('src',data.info.id_card_back);
                }else{
                    $('#TransferLine').each(function(k,v){
                        if(data.info.line_id == $(v).find(':selected').val()){
                            // 已经选中状态
                            window.w_id = data.info.id;

                            // 修改图片方法
                            var file1 = '<input type="file" name="file_one" id="file" accept="image/jpeg,image/jpg,image/png" atd="1" onclick="fileOnchange(this)" />';
                            var file2 = '<input type="file" name="file_two" id="files" accept="image/jpeg,image/jpg,image/png" atd="2" onclick="fileOnchange(this)" />';
                            $('#obcontid1 input').remove();
                            $('#obcontid2 input').remove();
                            $('#obcontid1 img').after(file1);
                            $('#obcontid2 img').after(file2);

                            $('#fileimage1').attr('src',data.info.id_card_front);
                            $('#fileimage2').attr('src',data.info.id_card_back);                    
                        }else{
                            // 没有选中
                            //alert('3');
                            $("#TransferLine option[value='"+data.info.line_id+"']").attr('selected',true);
                            window.w_id = data.info.id;
                            $(v).find(':selected').change();
                        }
                    });
                }
            }
        }
    })
}
//选择寄件人按钮
function addsern(obj){
    layer.open({
        type: 2,
        title: "{:L('l_select_sender')}",
        area : ['90%' , '80%'],
        offset: '5%',
        closeBtn: 1,
        content: "{:U('sender/getSenderInfo')}",
    });
}
// 选择寄件人数据
function senderAjax(id){
    $.ajax({
        url: "{:U('Sender/senderAjax')}",
        type:'POST', 
        cache: false,    
        data:{
           'id' : id
        },
        dataType:'json', 
        success:function(data){
            $('#tempForm').validationEngine('hideAll');   
            $("#MainContent_ddProvince").find("option:selected").removeAttr("selected");
            $("#MainContent_ddCity").find("option:selected").removeAttr("selected");
            $('#postname').val(data.s_name);
            $('#poststreet').val(data.s_street);
            $('#Postcountry').val(data.s_country);
            $('#Postprovince').val(data.s_state);
            $('#Postcity').val(data.s_city);
            $('#postphone').val(data.s_tel);
            $('#postcode').val(data.s_code);
            s_send_addr(data.s_state,data.s_city);
        }
    });
}
// 美国地址
function s_send_addr(sendstate,sendcity){
  $('#MainContent_ddProvince').change(
      (function(Cr_Select){
        return function(Cr_Select){
          var sit = $(this).children('option:selected').html();
          if(sit===Cr_Select){             
            $("#Postprovince").attr("value","");
            $("#PostCity").attr("value","");
          }else{
            $("#Postprovince").attr("value",sit);
          } 
      };
    })(Cr_Select)
  );
  if(sendstate != ''){
      $("#MainContent_ddProvince").find("option[value='"+sendstate+"']").prop("selected",true).trigger('change');
  }else{
      $("#MainContent_ddProvince").children('option:selected').html(sendstate);
  }
  $("#MainContent_ddCity").change(
      (function(Cr_Select){
        return function(Cr_Select){
          var sit = $(this).children('option:selected').html();
          if(sit===Cr_Select){             
            $("#Postprovince").attr("value","");
            $("#Postcity").attr("value","");
          }else{
            $("#Postcity").attr("value",sit);
          } 
      }
    })(Cr_Select)
  );
  if(sendcity != ''){
      $("#MainContent_ddCity").find("option:contains('"+sendcity+"')").prop("selected",true);
      $("#Postcity").attr("value",sendcity);
  }else{
      $("#MainContent_ddCity").children('option:selected').html(sendcity); 
  }
}
$(function(){
    var sendstate = "{$info['PostState']}";
    var sendcity  = "{$info['PostCity']}";
    s_send_addr(sendstate,sendcity);
});
</script>
<!-- END -->
	<div class="foot"></div>

</block>

</body>
</html>